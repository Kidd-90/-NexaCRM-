@page "/notification-settings-page"
@attribute [Authorize(Roles = "Manager,Admin,Developer,Sales")]
@using Microsoft.Extensions.Localization
@using NexaCRM.Services.Admin.Interfaces
@using NexaCRM.Services.Admin.Models.Settings
@inject IStringLocalizer<NotificationSettingsPage> Localizer
@inject INotificationService NotificationService

<div class="position-relative d-flex h-screen flex-column bg-surface-soft overflow-hidden"
      style="--select-button-svg: url('data:image/svg+xml,%3csvg xmlns=%27http://www.w3.org/2000/svg%27 width=%2724px%27 height=%2724px%27 fill=%27rgb(77,106,153)%27 viewBox=%270 0 256 256%27%3e%3cpath d=%27M181.66,170.34a8,8,0,0,1,0,11.32l-48,48a8,8,0,0,1-11.32,0l-48-48a8,8,0,0,1,11.32-11.32L128,212.69l42.34-42.35A8,8,0,0,1,181.66,170.34Zm-96-84.68L128,43.31l42.34,42.35a8,8,0,0,0,11.32-11.32l-48-48a8,8,0,0,0-11.32,0l-48,48A8,8,0,0,0,85.66,85.66Z%27%3e%3c/path%3e%3c/svg%3e')"
    >
      <div class="layout-container d-flex h-100 flex-grow-1 flex-column overflow-hidden">
        <div class="px-4 d-flex flex-grow-1 justify-content-center py-5 overflow-y-auto">
          <div class="layout-content-container d-flex flex-column ui-max-w-960 w-100">
            <div class="d-flex flex-wrap justify-content-between gap-3 p-2">
              <div class="d-flex ui-min-w-18rem flex-column gap-3">
                <p class="text-ink fs-2 fw-bold lh-sm">@Localizer["NotificationSettings"]</p>
                <p class="text-ink-muted small fw-normal lh-base">@Localizer["NotificationSettingsDescription"]</p>
              </div>
            </div>
            <h3 class="text-ink fs-4 fw-bold lh-sm px-2 pb-2 pt-4">@Localizer["NewLeads"]</h3>
            <div class="d-flex align-items-center gap-4 bg-surface-soft px-2 ui-min-h-72 py-2 justify-content-between">
              <div class="d-flex flex-column justify-content-center">
                <p class="text-ink fs-5 fw-semibold lh-base line-clamp-1">@Localizer["NewLeadCreated"]</p>
                <p class="text-ink-muted small fw-normal lh-base line-clamp-2">@Localizer["NewLeadCreatedDescription"]</p>
              </div>
              <div class="shrink-0">
                <label
                  class="position-relative d-flex ui-height-31 ui-width-51 align-items-center rounded-pill border-0 bg-accent-soft p-0.5"
                >
                  <div class="h-100 ui-width-27 rounded-pill bg-white" style="box-shadow: rgba(0, 0, 0, 0.15) 0px 3px 8px, rgba(0, 0, 0, 0.06) 0px 3px 1px;"></div>
                  <input type="checkbox" class="invisible position-absolute" @bind="settings.NewLeadCreated" />
                </label>
              </div>
            </div>
            <div class="d-flex align-items-center gap-4 bg-surface-soft px-2 ui-min-h-72 py-2 justify-content-between">
              <div class="d-flex flex-column justify-content-center">
                <p class="text-ink fs-5 fw-semibold lh-base line-clamp-1">@Localizer["LeadStatusUpdated"]</p>
                <p class="text-ink-muted small fw-normal lh-base line-clamp-2">@Localizer["LeadStatusUpdatedDescription"]</p>
              </div>
              <div class="shrink-0">
                <label
                  class="position-relative d-flex ui-height-31 ui-width-51 align-items-center rounded-pill border-0 bg-accent-soft p-0.5"
                >
                  <div class="h-100 ui-width-27 rounded-pill bg-white" style="box-shadow: rgba(0, 0, 0, 0.15) 0px 3px 8px, rgba(0, 0, 0, 0.06) 0px 3px 1px;"></div>
                  <input type="checkbox" class="invisible position-absolute" @bind="settings.LeadStatusUpdated" />
                </label>
              </div>
            </div>
            <h3 class="text-ink fs-4 fw-bold lh-sm px-2 pb-2 pt-4">@Localizer["DealUpdates"]</h3>
            <div class="d-flex align-items-center gap-4 bg-surface-soft px-2 ui-min-h-72 py-2 justify-content-between">
              <div class="d-flex flex-column justify-content-center">
                <p class="text-ink fs-5 fw-semibold lh-base line-clamp-1">@Localizer["DealStageChanged"]</p>
                <p class="text-ink-muted small fw-normal lh-base line-clamp-2">@Localizer["DealStageChangedDescription"]</p>
              </div>
              <div class="shrink-0">
                <label
                  class="position-relative d-flex ui-height-31 ui-width-51 align-items-center rounded-pill border-0 bg-accent-soft p-0.5"
                >
                  <div class="h-100 ui-width-27 rounded-pill bg-white" style="box-shadow: rgba(0, 0, 0, 0.15) 0px 3px 8px, rgba(0, 0, 0, 0.06) 0px 3px 1px;"></div>
                  <input type="checkbox" class="invisible position-absolute" @bind="settings.DealStageChanged" />
                </label>
              </div>
            </div>
            <div class="d-flex align-items-center gap-4 bg-surface-soft px-2 ui-min-h-72 py-2 justify-content-between">
              <div class="d-flex flex-column justify-content-center">
                <p class="text-ink fs-5 fw-semibold lh-base line-clamp-1">@Localizer["DealValueUpdated"]</p>
                <p class="text-ink-muted small fw-normal lh-base line-clamp-2">@Localizer["DealValueUpdatedDescription"]</p>
              </div>
              <div class="shrink-0">
                <label
                  class="position-relative d-flex ui-height-31 ui-width-51 align-items-center rounded-pill border-0 bg-accent-soft p-0.5"
                >
                  <div class="h-100 ui-width-27 rounded-pill bg-white" style="box-shadow: rgba(0, 0, 0, 0.15) 0px 3px 8px, rgba(0, 0, 0, 0.06) 0px 3px 1px;"></div>
                  <input type="checkbox" class="invisible position-absolute" @bind="settings.DealValueUpdated" />
                </label>
              </div>
            </div>
            <h3 class="text-ink fs-4 fw-bold lh-sm px-2 pb-2 pt-4">@Localizer["TaskAssignments"]</h3>
            <div class="d-flex align-items-center gap-4 bg-surface-soft px-2 ui-min-h-72 py-2 justify-content-between">
              <div class="d-flex flex-column justify-content-center">
                <p class="text-ink fs-5 fw-semibold lh-base line-clamp-1">@Localizer["NewTaskAssigned"]</p>
                <p class="text-ink-muted small fw-normal lh-base line-clamp-2">@Localizer["NewTaskAssignedDescription"]</p>
              </div>
              <div class="shrink-0">
                <label
                  class="position-relative d-flex ui-height-31 ui-width-51 align-items-center rounded-pill border-0 bg-accent-soft p-0.5"
                >
                  <div class="h-100 ui-width-27 rounded-pill bg-white" style="box-shadow: rgba(0, 0, 0, 0.15) 0px 3px 8px, rgba(0, 0, 0, 0.06) 0px 3px 1px;"></div>
                  <input type="checkbox" class="invisible position-absolute" @bind="settings.NewTaskAssigned" />
                </label>
              </div>
            </div>
            <div class="d-flex align-items-center gap-4 bg-surface-soft px-2 ui-min-h-72 py-2 justify-content-between">
              <div class="d-flex flex-column justify-content-center">
                <p class="text-ink fs-5 fw-semibold lh-base line-clamp-1">@Localizer["TaskDueDateReminder"]</p>
                <p class="text-ink-muted small fw-normal lh-base line-clamp-2">@Localizer["TaskDueDateReminderDescription"]</p>
              </div>
              <div class="shrink-0">
                <label
                  class="position-relative d-flex ui-height-31 ui-width-51 align-items-center rounded-pill border-0 bg-accent-soft p-0.5"
                >
                  <div class="h-100 ui-width-27 rounded-pill bg-white" style="box-shadow: rgba(0, 0, 0, 0.15) 0px 3px 8px, rgba(0, 0, 0, 0.06) 0px 3px 1px;"></div>
                  <input type="checkbox" class="invisible position-absolute" @bind="settings.TaskDueDateReminder" />
                </label>
              </div>
            </div>
            <h3 class="text-ink fs-4 fw-bold lh-sm px-2 pb-2 pt-4">@Localizer["NotificationChannels"]</h3>
            <div class="d-flex align-items-center gap-4 bg-surface-soft px-2 ui-min-h-72 py-2 justify-content-between">
              <div class="d-flex flex-column justify-content-center">
                <p class="text-ink fs-5 fw-semibold lh-base line-clamp-1">@Localizer["EmailNotifications"]</p>
                <p class="text-ink-muted small fw-normal lh-base line-clamp-2">@Localizer["EmailNotificationsDescription"]</p>
              </div>
              <div class="shrink-0">
                <label
                  class="position-relative d-flex ui-height-31 ui-width-51 align-items-center rounded-pill border-0 bg-accent-soft p-0.5"
                >
                  <div class="h-100 ui-width-27 rounded-pill bg-white" style="box-shadow: rgba(0, 0, 0, 0.15) 0px 3px 8px, rgba(0, 0, 0, 0.06) 0px 3px 1px;"></div>
                  <input type="checkbox" class="invisible position-absolute" @bind="settings.EmailNotifications" />
                </label>
              </div>
            </div>
            <div class="d-flex align-items-center gap-4 bg-surface-soft px-2 ui-min-h-72 py-2 justify-content-between">
              <div class="d-flex flex-column justify-content-center">
                <p class="text-ink fs-5 fw-semibold lh-base line-clamp-1">@Localizer["InAppNotifications"]</p>
                <p class="text-ink-muted small fw-normal lh-base line-clamp-2">@Localizer["InAppNotificationsDescription"]</p>
              </div>
              <div class="shrink-0">
                <label
                  class="position-relative d-flex ui-height-31 ui-width-51 align-items-center rounded-pill border-0 bg-accent-soft p-0.5"
                >
                  <div class="h-100 ui-width-27 rounded-pill bg-white" style="box-shadow: rgba(0, 0, 0, 0.15) 0px 3px 8px, rgba(0, 0, 0, 0.06) 0px 3px 1px;"></div>
                  <input type="checkbox" class="invisible position-absolute" @bind="settings.InAppNotifications" />
                </label>
              </div>
            </div>
            <div class="d-flex align-items-center gap-4 bg-surface-soft px-2 ui-min-h-72 py-2 justify-content-between">
              <div class="d-flex flex-column justify-content-center">
                <p class="text-ink fs-5 fw-semibold lh-base line-clamp-1">@Localizer["PushNotifications"]</p>
                <p class="text-ink-muted small fw-normal lh-base line-clamp-2">@Localizer["PushNotificationsDescription"]</p>
              </div>
              <div class="shrink-0">
                <label
                  class="position-relative d-flex ui-height-31 ui-width-51 align-items-center rounded-pill border-0 bg-accent-soft p-0.5"
                >
                  <div class="h-100 ui-width-27 rounded-pill bg-white" style="box-shadow: rgba(0, 0, 0, 0.15) 0px 3px 8px, rgba(0, 0, 0, 0.06) 0px 3px 1px;"></div>
                  <input type="checkbox" class="invisible position-absolute" @bind="settings.PushNotifications" />
                </label>
              </div>
            </div>
            <h3 class="text-ink fs-4 fw-bold lh-sm px-2 pb-2 pt-4">@Localizer["NotificationFrequency"]</h3>
            <div class="d-flex w-100 flex-wrap align-items-end gap-4 px-2 py-3">
              <label class="d-flex flex-column min-w-0 flex-grow-1">
                <p class="text-ink fs-5 fw-semibold lh-base pb-2">@Localizer["Frequency"]</p>
                <select
                  class="form-input d-flex w-100 min-w-0 flex-grow-1 overflow-hidden rounded-3 text-ink border border-soft bg-surface-soft ui-input-height-lg p-3 fs-5 fw-normal lh-base"
                >
                  <option value="one"></option>
                  <option value="two">two</option>
                  <option value="three">three</option>
                </select>
              </label>
            </div>
            <h3 class="text-ink fs-4 fw-bold lh-sm px-2 pb-2 pt-4">@Localizer["SnoozeOptions"]</h3>
            <div class="d-flex w-100 flex-wrap align-items-end gap-4 px-2 py-3">
              <label class="d-flex flex-column min-w-0 flex-grow-1">
                <p class="text-ink fs-5 fw-semibold lh-base pb-2">@Localizer["SnoozeDuration"]</p>
                <select
                  class="form-input d-flex w-100 min-w-0 flex-grow-1 overflow-hidden rounded-3 text-ink border border-soft bg-surface-soft ui-input-height-lg p-3 fs-5 fw-normal lh-base"
                >
                  <option value="one"></option>
                  <option value="two">two</option>
                  <option value="three">three</option>
                </select>
              </label>
            </div>
            <div class="d-flex px-2 py-3 justify-content-end">
              <button
                class="d-flex ui-min-w-84px ui-max-w-480 align-items-center justify-content-center overflow-hidden rounded-3 ui-input-height px-4 bg-primary text-white small fw-bold lh-base"
                @onclick="SaveSettings"
                disabled="@(isLoading || isSaving)"
              >
                @if (isSaving)
                {
                  <span class="truncate">저장 중...</span>
                }
                else
                {
                  <span class="truncate">@Localizer["SaveSettings"]</span>
                }
              </button>
            </div>
            
            @if (isLoading)
            {
              <div class="px-2 py-2 text-primary small">
                ⏳ 설정을 불러오는 중...
              </div>
            }
            
            @if (!string.IsNullOrEmpty(statusMessage))
            {
              <div class="px-2 py-2 text-success small fw-semibold">
                ✅ @statusMessage
              </div>
            }
            
            @if (!string.IsNullOrEmpty(errorMessage))
            {
              <div class="px-2 py-2 text-red-600 small fw-semibold">
                ❌ @errorMessage
              </div>
            }
            
            <!-- 하단 여백 추가 -->
            <div class="pb-8"></div>
      </div>
    </div>
  </div>
</div>

@code {
    private NotificationSettings settings = new();
    private string? statusMessage;
    private string? errorMessage;
    private bool isLoading = true;
    private bool isSaving = false;
    private bool mobileMenuOpen;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            isLoading = true;
            errorMessage = null;
            settings = await NotificationService.GetSettingsAsync();
        }
        catch (Exception ex)
        {
            errorMessage = $"설정을 불러오는 중 오류가 발생했습니다: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task SaveSettings()
    {
        try
        {
            isSaving = true;
            statusMessage = null;
            errorMessage = null;
            
            await NotificationService.SaveSettingsAsync(settings);
            statusMessage = Localizer["SettingsSaved"];
            
            // 3초 후 메시지 자동 제거
            await Task.Delay(3000);
            statusMessage = null;
        }
        catch (Exception ex)
        {
            errorMessage = $"설정을 저장하는 중 오류가 발생했습니다: {ex.Message}";
        }
        finally
        {
            isSaving = false;
        }
    }

    private void ToggleMobileMenu()
    {
        mobileMenuOpen = !mobileMenuOpen;
    }
}
