@page "/sms/bulk"
@attribute [Authorize(Roles = "Sales,Manager")]
@using System.IO
@using System.Linq
@using System.Text
@using System.Text.RegularExpressions
@using NexaCRM.Services.Admin.Models.Sms
@using NexaCRM.Services.Admin.Interfaces
@inject ISmsService SmsService

<ResponsivePage class="common-page-container">
    <div class="sms-page">
        <section class="sms-card sms-page-header">
            <div class="sms-page-title">
                <h2 class="sms-title">ë¬¸ìë©”ì„¸ì§€ë°œì†¡</h2>
                <p class="sms-subtitle">ëŒ€ëŸ‰ ë°œì†¡ ì „ í…œí”Œë¦¿ê³¼ ìˆ˜ì‹ ìë¥¼ ë¯¸ë¦¬ í™•ì¸í•˜ì„¸ìš”.</p>
            </div>
            <div class="sms-stats-grid">
                <div class="sms-stat-card">
                    <span class="sms-stat-label">ì´ ë°œì†¡ê±´ìˆ˜</span>
                    <span class="sms-stat-value">@Summary.TotalMessages.ToString("N0")</span>
                </div>
                <div class="sms-stat-card">
                    <span class="sms-stat-label">ì˜¤ëŠ˜ ë°œì†¡</span>
                    <span class="sms-stat-value">@Summary.TodaySent.ToString("N0")</span>
                </div>
                <div class="sms-stat-card">
                    <span class="sms-stat-label">ë³´ìœ  í¬ì¸íŠ¸</span>
                    <span class="sms-stat-value">@Summary.AvailablePoints.ToString("N0")</span>
                </div>
                <div class="sms-stat-card">
                    <span class="sms-stat-label">ì”ì—¬ í¬ì¸íŠ¸</span>
                    <span class="sms-stat-value">@Summary.RemainingPoints.ToString("N0")</span>
                </div>
            </div>
        </section>

        <div class="sms-warning sms-card">
            <div class="sms-warning-icon">!</div>
            <div>
                <h6 class="sms-warning-title">ë°œì†¡ ì „ í™•ì¸í•´ì£¼ì„¸ìš”</h6>
                <p class="sms-warning-text mb-0">
                    ë°œì‹ ë²ˆí˜¸ ì‚¬ì „ë“±ë¡ ë° ê´‘ê³ ì„± ì •ë³´ ë°œì†¡ ì‹œ ê´€ë ¨ ë²•ë ¹ì„ ë°˜ë“œì‹œ ì¤€ìˆ˜í•´ì£¼ì„¸ìš”. ê³ ê°ì´ ìˆ˜ì‹  ê±°ë¶€ë¥¼ ìš”ì²­í•œ ê²½ìš° ì¦‰ì‹œ ë°˜ì˜í•´ì•¼ í•©ë‹ˆë‹¤.
                </p>
            </div>
        </div>

        <div class="sms-content-grid">
            <section class="sms-card sms-message-card">
                <div class="sms-section-title">
                    <span class="sms-section-badge">STEP 1</span>
                    <div>
                        <h4 class="mb-1">ë©”ì‹œì§€ ì‘ì„±</h4>
                        <p class="text-muted mb-0">í…œí”Œë¦¿ì„ ì„ íƒí•˜ê³  í”Œë ˆì´ìŠ¤í™€ë”ë¥¼ ì±„ì›Œ ë§ì¶¤í˜• ë¬¸ìë¥¼ ì™„ì„±í•˜ì„¸ìš”.</p>
                    </div>
                </div>

                <div class="sms-phone-preview">
                    <div class="sms-phone-shell">
                        <div class="sms-phone-notch"></div>
                        <div class="sms-phone-header">
                            <span class="sms-phone-time">@DateTime.Now.ToString("HH:mm")</span>
                            <span class="sms-phone-sender">Nexa CRM</span>
                        </div>
                        <div class="sms-phone-screen">
                            <div class="sms-preview-bubble">
                                <pre>@MessagePreview</pre>
                            </div>
                            <div class="sms-preview-hint">â€» ì‹¤ì œ ìˆ˜ì‹ í™”ë©´ê³¼ ë‹¤ë¥¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</div>
                        </div>
                        <div class="sms-phone-input">
                            <div class="sms-phone-placeholder">ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”...</div>
                            <div class="sms-phone-send">â</div>
                        </div>
                    </div>
                </div>

                <div class="sms-form-group">
                    <label class="form-label fw-semibold">í…œí”Œë¦¿ ì„ íƒ</label>
                    <select class="form-select" @onchange="OnTemplateChanged">
                        <option value="">í…œí”Œë¦¿ì„ ì„ íƒí•˜ê±°ë‚˜ ì§ì ‘ ì‘ì„±í•˜ì„¸ìš”</option>
                        @foreach (var template in Templates)
                        {
                            <option value="@template.Id" selected="@Equals(template.Id, SelectedTemplateId)">@template.Title</option>
                        }
                    </select>
                    @if (SelectedTemplate is not null)
                    {
                        <div class="sms-template-description">
                            <span class="badge text-bg-light">@SelectedTemplate.Category</span>
                            <span>@SelectedTemplate.Description</span>
                        </div>
                    }
                </div>

                @if (Placeholders.Any())
                {
                    <div class="sms-placeholder-grid">
                        @foreach (var placeholder in Placeholders)
                        {
                            <div class="sms-placeholder-field">
                                <label class="form-label">@placeholder</label>
                                <InputText class="form-control"
                                           placeholder="@($"{placeholder} ì…ë ¥")"
                                           Value="@(PlaceholderValues.TryGetValue(placeholder, out var value) ? value : string.Empty)"
                                           ValueChanged="value => OnPlaceholderChanged(placeholder, value)" />
                            </div>
                        }
                    </div>
                }

                <div class="sms-form-group">
                    <label class="form-label fw-semibold">ë¬¸ì ë‚´ìš©</label>
                    <InputTextArea class="form-control sms-message-textarea"
                                   rows="6"
                                   @bind-Value="Message" />
                    <div class="sms-message-meta">
                        <span>ë¬¸ì ê¸¸ì´</span>
                        <span><strong>@MessageByteCount</strong> / @MessageByteLimit byte</span>
                    </div>
                    <div class="sms-message-meta">
                        <span>ì˜ˆìƒ ë°œì†¡ ê±´ìˆ˜</span>
                        <span><strong>@EstimatedSegments</strong>ê±´ Â· ì˜ˆìƒ í¬ì¸íŠ¸ <strong>@EstimatedPointCost.ToString("N0")</strong>P</span>
                    </div>
                </div>

                <div class="sms-options">
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="autoLineBreakSwitch" checked="@AutoLineBreak" @onchange="OnAutoLineBreakChanged">
                        <label class="form-check-label" for="autoLineBreakSwitch">ìë™ ì¤„ë°”ê¿ˆ (SMS/LMS ìš©ëŸ‰ ìë™ ê³„ì‚°)</label>
                    </div>
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="includeOptOutSwitch" checked="@IncludeOptOut" @onchange="OnIncludeOptOutChanged">
                        <label class="form-check-label" for="includeOptOutSwitch">ìˆ˜ì‹ ê±°ë¶€ ë¬¸êµ¬ ìë™ ì¶”ê°€</label>
                    </div>
                </div>

                <div class="sms-send-footer">
                    <div class="sms-selected-info">
                        <div>ì„ íƒëœ ìˆ˜ì‹ ì <strong>@SelectedRecipientPhones.Count</strong>ëª…</div>
                        <div class="text-muted">ì´ ì˜ˆìƒ ë°œì†¡ëŸ‰ <strong>@(SelectedRecipientPhones.Count * EstimatedSegments)</strong>ê±´</div>
                    </div>
                    <button class="btn btn-primary sms-send-btn" type="button" @onclick="SendAsync" disabled="@SendDisabled">
                        @(IsSending ? "ë°œì†¡ ì¤‘..." : "ë¬¸ì ë°œì†¡")
                    </button>
                </div>

                @if (IsSending)
                {
                    <div class="progress sms-progress mt-3">
                        <div class="progress-bar" role="progressbar" style="width:@Progress%" aria-valuenow="@Progress" aria-valuemin="0" aria-valuemax="100">@Progress%</div>
                    </div>
                }
            </section>

            <aside class="sms-card sms-address-card">
                <div class="sms-section-title">
                    <span class="sms-section-badge">STEP 2</span>
                    <div>
                        <h4 class="mb-1">SMS ì£¼ì†Œë¡ ì„ íƒ</h4>
                        <p class="text-muted mb-0">í•„ìš”í•œ ê³ ê°ì„ ê²€ìƒ‰í•˜ê±°ë‚˜ ì¶”ê°€í•´ ë°œì†¡ ëŒ€ìƒì„ êµ¬ì„±í•˜ì„¸ìš”.</p>
                    </div>
                </div>

                <div class="sms-address-actions">
                    <div class="sms-upload-wrapper">
                        <label class="btn btn-outline-secondary btn-sm mb-0">
                            ì—‘ì…€ ì¶”ê°€
                            <InputFile OnChange="OnRecipientsFileUploaded" accept=".csv,.txt" class="d-none" />
                        </label>
                        <span class="text-muted small">CSV(ì´ë¦„,ì—°ë½ì²˜) í˜•ì‹ ì§€ì›</span>
                    </div>
                    <button class="btn btn-outline-danger btn-sm" type="button" @onclick="RemoveSelectedRecipients" disabled="@(SelectedRecipientPhones.Count == 0)">ì„ íƒ ì‚­ì œ</button>
                </div>

                @if (!string.IsNullOrWhiteSpace(ImportFeedback))
                {
                    <div class="sms-import-feedback">@ImportFeedback</div>
                }

                <div class="sms-search-row">
                    <div class="input-group">
                        <span class="input-group-text">ğŸ”</span>
                        <InputText class="form-control" @bind-Value="RecipientSearch" placeholder="ì´ë¦„ ë˜ëŠ” ì—°ë½ì²˜ ê²€ìƒ‰" />
                    </div>
                </div>

                <div class="sms-add-recipient">
                    <div class="row g-2">
                        <div class="col-12 col-md-4">
                            <InputText class="form-control" @bind-Value="NewRecipientName" placeholder="ì´ë¦„" />
                        </div>
                        <div class="col-12 col-md-5">
                            <InputText class="form-control" @bind-Value="NewRecipientPhone" placeholder="ì—°ë½ì²˜ (ìˆ«ìë§Œ)" />
                        </div>
                        <div class="col-12 col-md-3 d-grid">
                            <button class="btn btn-outline-primary" type="button" @onclick="AddRecipient">ì¶”ê°€</button>
                        </div>
                    </div>
                    @if (!string.IsNullOrWhiteSpace(AddRecipientError))
                    {
                        <div class="text-danger small mt-1">@AddRecipientError</div>
                    }
                </div>

                <div class="sms-table-wrapper">
                    <table class="table sms-recipient-table">
                        <thead>
                            <tr>
                                <th scope="col" class="text-center">
                                    <input type="checkbox" class="form-check-input" checked="@AreAllFilteredSelected" @onchange="ToggleAllFiltered" />
                                </th>
                                <th scope="col">ì´ë¦„</th>
                                <th scope="col">ì—°ë½ì²˜</th>
                                <th scope="col" class="text-end">ìƒíƒœ</th>
                            </tr>
                        </thead>
                        <tbody>
                            @if (!FilteredRecipients.Any())
                            {
                                <tr>
                                    <td colspan="4" class="text-center text-muted py-4">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</td>
                                </tr>
                            }
                            else
                            {
                                @foreach (var recipient in FilteredRecipients)
                                {
                                    <tr class="@GetRecipientRowClass(recipient)">
                                        <td class="text-center">
                                            <input type="checkbox"
                                                   class="form-check-input"
                                                   checked="@IsRecipientSelected(recipient)"
                                                   @onchange="(_) => ToggleRecipient(recipient)" />
                                        </td>
                                        <td>
                                            <div class="fw-semibold">@recipient.Name</div>
                                            <div class="sms-recipient-tags">
                                                <span class="badge rounded-pill text-bg-light">@recipient.Group</span>
                                            </div>
                                        </td>
                                        <td class="text-nowrap">@FormatPhone(recipient.Phone)</td>
                                        <td class="text-end">
                                            <button class="btn btn-link btn-sm text-decoration-none p-0"
                                                    type="button"
                                                    @onclick="() => ToggleRecipient(recipient)">
                                                @(IsRecipientSelected(recipient) ? "í•´ì œ" : "ì¶”ê°€")
                                            </button>
                                        </td>
                                    </tr>
                                }
                            }
                        </tbody>
                    </table>
                </div>

                <div class="sms-selected-summary">
                    <div>ì´ <strong>@FilteredRecipients.Count()</strong>ëª… ì¤‘ <strong>@SelectedRecipientPhones.Count</strong>ëª… ì„ íƒë¨</div>
                    <div class="text-muted">Excel ì—…ë¡œë“œ ë˜ëŠ” ì§ì ‘ ì¶”ê°€ë¡œ ì£¼ì†Œë¡ì„ í™•ì¥í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</div>
                </div>
            </aside>
        </div>
    </div>
</ResponsivePage>

@code {
    private readonly SmsSummary Summary = new(1_039_998, 142, 1_000_000, 857_438);

    private readonly List<TemplateOption> Templates = new()
    {
        new("promotion", "ì‹ ê·œ í”„ë¡œëª¨ì…˜ ì•ˆë‚´", "ì•ˆë…•í•˜ì„¸ìš” {Name} ê³ ê°ë‹˜!\nì´ë²ˆ ì£¼ë§Œ ì§„í–‰ë˜ëŠ” {Product} íŠ¹ë³„ í˜œíƒì„ ë†“ì¹˜ì§€ ë§ˆì„¸ìš”.", "ì‹ ê·œ ì´ë²¤íŠ¸ ë° í”„ë¡œëª¨ì…˜ ì•ˆë‚´", "í”„ë¡œëª¨ì…˜"),
        new("reservation", "ì˜ˆì•½ ì¼ì • ì•Œë¦¼", "{Name} ê³ ê°ë‹˜, {Date} {Time}ì— ì˜ˆì•½ì´ ì˜ˆì •ë˜ì–´ ìˆìŠµë‹ˆë‹¤.\në°©ë¬¸ì´ ì–´ë ¤ìš°ì‹œë©´ ë¯¸ë¦¬ ì—°ë½ ë¶€íƒë“œë¦½ë‹ˆë‹¤.", "ì˜ˆì•½ ë° ì¼ì • ì•Œë¦¼", "ì•ˆë‚´"),
        new("survey", "ë§Œì¡±ë„ ì¡°ì‚¬ ì°¸ì—¬ ìš”ì²­", "{Name} ê³ ê°ë‹˜, ì„œë¹„ìŠ¤ ë§Œì¡±ë„ ì¡°ì‚¬ë¥¼ ë„ì™€ì£¼ì‹œë©´ ë‹¤ìŒ ìƒë‹´ì— ë” ë‚˜ì€ í˜œíƒì„ ë“œë¦´ê²Œìš”.\në§í¬: {Link}", "ë§Œì¡±ë„ ë° ì„¤ë¬¸ ìš”ì²­", "í”¼ë“œë°±")
    };

    private List<SmsRecipient> AvailableRecipients = new()
    {
        new("ê¹€ì˜ìˆ˜", "01012345678", "VIP"),
        new("ë°•ë¯¼ì§€", "01098765432", "ì‹ ê·œ"),
        new("ì´ì„œì¤€", "01034567890", "ì¥ê¸°ê³ ê°"),
        new("ìµœì§€ìš°", "01045671234", "ê´€ì‹¬ê³ ê°"),
        new("ì •í•˜ëŠ˜", "01067891234", "ì„¸ë¯¸ë‚˜ì°¸ì„"),
        new("í™ì§€ë¯¼", "01078901234", "B2B"),
        new("ë‚¨ë„í˜„", "01023456789", "êµ¬ë…"),
        new("ì„œìœ¤ì•„", "01011223344", "íœ´ë©´")
    };

    private readonly HashSet<string> SelectedRecipientPhones = new(StringComparer.Ordinal);
    private readonly List<string> Placeholders = new();
    private readonly Dictionary<string, string> PlaceholderValues = new();

    private string? SelectedTemplateId;
    private TemplateOption? SelectedTemplate => Templates.FirstOrDefault(t => t.Id == SelectedTemplateId);

    private string Message = string.Empty;
    private bool AutoLineBreak = true;
    private bool IncludeOptOut;
    private string RecipientSearch = string.Empty;
    private string NewRecipientName = string.Empty;
    private string NewRecipientPhone = string.Empty;
    private string? AddRecipientError;
    private string? ImportFeedback;
    private bool IsSending;
    private int Progress;

    private const int ShortMessageLimit = 90;
    private const int LongMessageLimit = 2000;
    private const int PointsPerSegment = 15;
    private const string OptOutText = "[ìˆ˜ì‹ ê±°ë¶€ 080-123-4567]";

    private static readonly Regex PlaceholderPattern = new(@"{(.*?)}", RegexOptions.Compiled);
    private static readonly Regex DigitOnlyPattern = new(@"[^0-9]", RegexOptions.Compiled);

    private IEnumerable<SmsRecipient> FilteredRecipients
    {
        get
        {
            if (string.IsNullOrWhiteSpace(RecipientSearch))
            {
                return AvailableRecipients;
            }

            var query = RecipientSearch.Trim();
            var normalized = NormalizePhoneNumber(query);

            return AvailableRecipients.Where(r =>
                r.Name.Contains(query, StringComparison.OrdinalIgnoreCase) ||
                (!string.IsNullOrEmpty(normalized) && r.Phone.Contains(normalized, StringComparison.Ordinal)));
        }
    }

    private bool AreAllFilteredSelected =>
        FilteredRecipients.Any() && FilteredRecipients.All(r => SelectedRecipientPhones.Contains(r.Phone));

    private int MessageByteLimit => AutoLineBreak ? ShortMessageLimit : LongMessageLimit;
    private int MessageByteCount => Encoding.UTF8.GetByteCount(Message ?? string.Empty);
    private int EstimatedSegments => Math.Max(1, (int)Math.Ceiling(Math.Max(1, MessageByteCount) / (double)MessageByteLimit));
    private int EstimatedPointCost => SelectedRecipientPhones.Count * EstimatedSegments * PointsPerSegment;
    private string MessagePreview => string.IsNullOrWhiteSpace(Message) ? "ë©”ì‹œì§€ ë‚´ìš©ì„ ì…ë ¥í•˜ê±°ë‚˜ í…œí”Œë¦¿ì„ ì„ íƒí•˜ì„¸ìš”." : Message;
    private bool SendDisabled => !SelectedRecipientPhones.Any() || string.IsNullOrWhiteSpace(Message) || IsSending;

    private void OnTemplateChanged(ChangeEventArgs e)
    {
        SelectedTemplateId = e.Value?.ToString();
        Placeholders.Clear();
        PlaceholderValues.Clear();

        if (SelectedTemplate is null)
        {
            Message = string.Empty;
            return;
        }

        foreach (Match match in PlaceholderPattern.Matches(SelectedTemplate.Content))
        {
            var key = match.Groups[1].Value;
            if (!Placeholders.Contains(key))
            {
                Placeholders.Add(key);
                PlaceholderValues[key] = string.Empty;
            }
        }

        UpdateMessage();
    }

    private void OnPlaceholderChanged(string key, string? value)
    {
        PlaceholderValues[key] = value ?? string.Empty;
        UpdateMessage();
    }

    private void UpdateMessage()
    {
        if (SelectedTemplate is null)
        {
            return;
        }

        var content = SelectedTemplate.Content;
        foreach (var placeholder in Placeholders)
        {
            var replacement = PlaceholderValues.TryGetValue(placeholder, out var value)
                ? value ?? string.Empty
                : string.Empty;

            content = content.Replace($"{{{placeholder}}}", replacement, StringComparison.Ordinal);
        }

        Message = content;

        if (IncludeOptOut)
        {
            AppendOptOutText();
        }
    }

    private void OnAutoLineBreakChanged(ChangeEventArgs e)
    {
        AutoLineBreak = e.Value is bool value && value;
    }

    private void OnIncludeOptOutChanged(ChangeEventArgs e)
    {
        var newValue = e.Value is bool value && value;
        if (IncludeOptOut == newValue)
        {
            return;
        }

        IncludeOptOut = newValue;

        if (IncludeOptOut)
        {
            AppendOptOutText();
        }
        else
        {
            Message = RemoveOptOutText(Message);
        }
    }

    private void AppendOptOutText()
    {
        if (string.IsNullOrWhiteSpace(Message))
        {
            Message = OptOutText;
            return;
        }

        if (!Message.Contains(OptOutText, StringComparison.Ordinal))
        {
            Message = $"{Message.TrimEnd()}\n{OptOutText}";
        }
    }

    private static string RemoveOptOutText(string text)
    {
        if (string.IsNullOrWhiteSpace(text))
        {
            return string.Empty;
        }

        var cleaned = text
            .Replace($"\r\n{OptOutText}", string.Empty, StringComparison.Ordinal)
            .Replace($"\n{OptOutText}", string.Empty, StringComparison.Ordinal)
            .Replace(OptOutText, string.Empty, StringComparison.Ordinal);

        return cleaned.TrimEnd();
    }

    private void ToggleRecipient(SmsRecipient recipient)
    {
        if (SelectedRecipientPhones.Contains(recipient.Phone))
        {
            SelectedRecipientPhones.Remove(recipient.Phone);
        }
        else
        {
            SelectedRecipientPhones.Add(recipient.Phone);
        }
    }

    private bool IsRecipientSelected(SmsRecipient recipient) => SelectedRecipientPhones.Contains(recipient.Phone);

    private string GetRecipientRowClass(SmsRecipient recipient) => IsRecipientSelected(recipient) ? "selected" : string.Empty;

    private void ToggleAllFiltered(ChangeEventArgs e)
    {
        var shouldSelect = e.Value is bool value && value;
        var recipients = FilteredRecipients.ToList();

        if (shouldSelect)
        {
            foreach (var recipient in recipients)
            {
                SelectedRecipientPhones.Add(recipient.Phone);
            }
        }
        else
        {
            foreach (var recipient in recipients)
            {
                SelectedRecipientPhones.Remove(recipient.Phone);
            }
        }
    }

    private void RemoveSelectedRecipients()
    {
        if (!SelectedRecipientPhones.Any())
        {
            return;
        }

        AvailableRecipients.RemoveAll(r => SelectedRecipientPhones.Contains(r.Phone));
        SelectedRecipientPhones.Clear();
    }

    private void AddRecipient()
    {
        AddRecipientError = null;
        ImportFeedback = null;

        if (string.IsNullOrWhiteSpace(NewRecipientName))
        {
            AddRecipientError = "ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.";
            return;
        }

        if (string.IsNullOrWhiteSpace(NewRecipientPhone))
        {
            AddRecipientError = "ì—°ë½ì²˜ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.";
            return;
        }

        var name = NewRecipientName.Trim();
        var normalizedPhone = NormalizePhoneNumber(NewRecipientPhone);

        if (!IsValidPhoneNumber(normalizedPhone))
        {
            AddRecipientError = "ì˜¬ë°”ë¥¸ ì—°ë½ì²˜ í˜•ì‹ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.";
            return;
        }

        if (AvailableRecipients.Any(r => r.Phone == normalizedPhone))
        {
            AddRecipientError = "ì´ë¯¸ ë“±ë¡ëœ ì—°ë½ì²˜ì…ë‹ˆë‹¤.";
            return;
        }

        AvailableRecipients.Add(new SmsRecipient(name, normalizedPhone, "ì§ì ‘ ì¶”ê°€"));
        SelectedRecipientPhones.Add(normalizedPhone);

        NewRecipientName = string.Empty;
        NewRecipientPhone = string.Empty;
    }

    private async Task OnRecipientsFileUploaded(InputFileChangeEventArgs e)
    {
        var file = e.File;
        if (file is null)
        {
            return;
        }

        using var stream = file.OpenReadStream(512_000);
        using var reader = new StreamReader(stream, Encoding.UTF8);

        var added = 0;
        while (!reader.EndOfStream)
        {
            var line = await reader.ReadLineAsync() ?? string.Empty;
            if (string.IsNullOrWhiteSpace(line))
            {
                continue;
            }

            var parts = line.Split(new[] { ',', ';', '\t' }, StringSplitOptions.RemoveEmptyEntries);
            var name = parts.Length > 0 ? parts[0].Trim() : string.Empty;
            var phone = parts.Length > 1 ? parts[1].Trim() : parts[0].Trim();

            if (AddRecipientInternal(name, phone, "ì—‘ì…€ ì—…ë¡œë“œ"))
            {
                added++;
            }
        }

        ImportFeedback = added > 0
            ? $"{added}ëª…ì˜ ìˆ˜ì‹ ìê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤."
            : "ì¶”ê°€ëœ ìˆ˜ì‹ ìê°€ ì—†ìŠµë‹ˆë‹¤. íŒŒì¼ í˜•ì‹ì„ í™•ì¸í•´ì£¼ì„¸ìš”.";
    }

    private bool AddRecipientInternal(string? name, string? phone, string group, bool select = true)
    {
        var resolvedName = string.IsNullOrWhiteSpace(name) ? "ì´ë¦„ì—†ìŒ" : name.Trim();
        var normalizedPhone = NormalizePhoneNumber(phone);

        if (!IsValidPhoneNumber(normalizedPhone))
        {
            return false;
        }

        if (AvailableRecipients.Any(r => r.Phone == normalizedPhone))
        {
            if (select)
            {
                SelectedRecipientPhones.Add(normalizedPhone);
            }

            return false;
        }

        AvailableRecipients.Add(new SmsRecipient(resolvedName, normalizedPhone, group));

        if (select)
        {
            SelectedRecipientPhones.Add(normalizedPhone);
        }

        return true;
    }

    private static string NormalizePhoneNumber(string? value)
    {
        if (string.IsNullOrWhiteSpace(value))
        {
            return string.Empty;
        }

        var trimmed = value.Trim();

        if (trimmed.StartsWith("+", StringComparison.Ordinal))
        {
            return "+" + DigitOnlyPattern.Replace(trimmed.Substring(1), string.Empty);
        }

        return DigitOnlyPattern.Replace(trimmed, string.Empty);
    }

    private static bool IsValidPhoneNumber(string phone)
    {
        if (string.IsNullOrWhiteSpace(phone))
        {
            return false;
        }

        if (phone.StartsWith("+", StringComparison.Ordinal))
        {
            return phone.Length is >= 8 and <= 15;
        }

        return phone.Length is >= 9 and <= 11;
    }

    private string FormatPhone(string phone)
    {
        if (string.IsNullOrWhiteSpace(phone))
        {
            return string.Empty;
        }

        if (phone.StartsWith("+", StringComparison.Ordinal))
        {
            return phone;
        }

        return phone.Length switch
        {
            11 => $"{phone[..3]}-{phone.Substring(3, 4)}-{phone.Substring(7)}",
            10 => $"{phone[..3]}-{phone.Substring(3, 3)}-{phone.Substring(6)}",
            8 => $"{phone[..4]}-{phone.Substring(4)}",
            _ => phone
        };
    }

    private async Task SendAsync()
    {
        var recipients = AvailableRecipients
            .Where(r => SelectedRecipientPhones.Contains(r.Phone))
            .Select(r => r.Phone)
            .ToList();

        if (!recipients.Any())
        {
            return;
        }

        var batches = recipients
            .Chunk(10)
            .Select(chunk => new BulkSmsRequest(chunk.ToList(), Message))
            .ToList();

        IsSending = true;
        Progress = 0;
        var progress = new Progress<int>(p =>
        {
            Progress = p;
            InvokeAsync(StateHasChanged);
        });

        try
        {
            await SmsService.SendBulkAsync(batches, progress);
        }
        finally
        {
            IsSending = false;
        }
    }

    private record SmsRecipient(string Name, string Phone, string Group);
    private record TemplateOption(string Id, string Title, string Content, string Description, string Category);
    private record SmsSummary(int TotalMessages, int TodaySent, int AvailablePoints, int RemainingPoints);
}
