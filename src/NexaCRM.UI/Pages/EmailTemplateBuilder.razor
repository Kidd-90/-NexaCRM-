@page "/email-template-builder/{TemplateId:guid?}"
@using Microsoft.Extensions.Localization
@using NexaCRM.UI.Models
@using NexaCRM.UI.Services.Interfaces
@inject IStringLocalizer<EmailTemplateBuilder> Localizer
@inject IEmailTemplateService TemplateService

<div class="position-relative d-flex min-vh-100 flex-column bg-surface-soft overflow-x-hidden">
      <div class="layout-container d-flex h-100 flex-grow-1 flex-column">
        <header class="d-flex align-items-center justify-content-between text-nowrap border-bottom border border-soft px-4 py-3">
          <div class="d-flex align-items-center gap-4">
            <div class="d-flex align-items-center gap-4 text-ink">
              <div class="ui-size-4">
                <svg viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path
                    fill-rule="evenodd"
                    clip-rule="evenodd"
                    d="M24 18.4228L42 11.475V34.3663C42 34.7796 41.7457 35.1504 41.3601 35.2992L24 42V18.4228Z"
                    fill="currentColor"
                  ></path>
                  <path
                    fill-rule="evenodd"
                    clip-rule="evenodd"
                    d="M24 8.18819L33.4123 11.574L24 15.2071L14.5877 11.574L24 8.18819ZM9 15.8487L21 20.4805V37.6263L9 32.9945V15.8487ZM27 37.6263V20.4805L39 15.8487V32.9945L27 37.6263ZM25.354 2.29885C24.4788 1.98402 23.5212 1.98402 22.646 2.29885L4.98454 8.65208C3.7939 9.08038 3 10.2097 3 11.475V34.3663C3 36.0196 4.01719 37.5026 5.55962 38.098L22.9197 44.7987C23.6149 45.0671 24.3851 45.0671 25.0803 44.7987L42.4404 38.098C43.9828 37.5026 45 36.0196 45 34.3663V11.475C45 10.2097 44.2061 9.08038 43.0155 8.65208L25.354 2.29885Z"
                    fill="currentColor"
                  ></path>
                </svg>
              </div>
              <h2 class="text-ink fs-4 fw-bold lh-sm">@Localizer["SalesPro"]</h2>
            </div>
            <button class="p-2" @onclick="ToggleMenu" aria-label='@Localizer["Menu"]'>
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 256 256">
                <path d="M40 128a8 8 0 0 1 8-8h160a8 8 0 0 1 0 16H48a8 8 0 0 1-8-8Zm-8-48a8 8 0 0 1 8-8h160a8 8 0 0 1 0 16H48a8 8 0 0 1-8-8Zm168 88a8 8 0 0 1 8-8H48a8 8 0 0 0 0 16h160a8 8 0 0 1 8-8Z" />
              </svg>
            </button>
            <div class="@(isMenuOpen ? "d-flex" : "d-none") flex-column flex-md-row align-items-center gap-4 gap-md-5 d-md-flex">
              <a class="text-ink small fw-semibold lh-base" href="#">@Localizer["Sales"]</a>
              <a class="text-ink small fw-semibold lh-base" href="#">@Localizer["Marketing"]</a>
              <a class="text-ink small fw-semibold lh-base" href="#">@Localizer["Service"]</a>
              <a class="text-ink small fw-semibold lh-base" href="#">@Localizer["Analytics"]</a>
            </div>
          </div>
          <div class="d-flex flex-grow-1 justify-content-end gap-2 align-items-center">
            <label class="d-none d-md-flex flex-column ui-min-w-10rem ui-height-40 ui-max-w-256">
              <div class="d-flex w-100 flex-grow-1 align-items-stretch rounded-3 h-100">
                <div
                  class="text-ink-muted d-flex border-0 bg-accent-soft align-items-center justify-content-center pl-4 rounded-start-3 border-end-0"
                  data-icon="MagnifyingGlass"
                  data-size="24px"
                  data-weight="regular"
                >
                  <svg xmlns="http://www.w3.org/2000/svg" width="24px" height="24px" fill="currentColor" viewBox="0 0 256 256">
                    <path
                      d="M229.66,218.34l-50.07-50.06a88.11,88.11,0,1,0-11.31,11.31l50.06,50.07a8,8,0,0,0,11.32-11.32ZM40,112a72,72,0,1,1,72,72A72.08,72.08,0,0,1,40,112Z"
                    ></path>
                  </svg>
                </div>
                <input
                  placeholder='@Localizer["Search"]'
                  class="form-input d-flex w-100 min-w-0 flex-grow-1 overflow-hidden rounded-3 text-ink border-0 bg-accent-soft h-100 px-4 rounded-start-0 border-start-0 pl-2 fs-5 fw-normal lh-base"
                  value=""
                />
                </div>
              </label>
              <button
                class="d-none d-md-flex ui-max-w-480 align-items-center justify-content-center overflow-hidden rounded-3 ui-input-height bg-accent-soft text-ink gap-2 small fw-bold lh-base min-w-0 px-3"
              >
                <div class="text-ink" data-icon="Bell" data-size="20px" data-weight="regular">
                  <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" fill="currentColor" viewBox="0 0 256 256">
                    <path
                    d="M221.8,175.94C216.25,166.38,208,139.33,208,104a80,80,0,1,0-160,0c0,35.34-8.26,62.38-13.81,71.94A16,16,0,0,0,48,200H88.81a40,40,0,0,0,78.38,0H208a16,16,0,0,0,13.8-24.06ZM128,216a24,24,0,0,1-22.62-16h45.24A24,24,0,0,1,128,216ZM48,184c7.7-13.24,16-43.92,16-80a64,64,0,1,1,128,0c0,36.05,8.28,66.73,16,80Z"
                  ></path>
                </svg>
              </div>
            </button>
              <div
                class="ui-aspect-square rounded-pill ui-size-10"
                style='background-image: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);'
              ></div>
            </div>
          </header>
        <div class="gap-1 px-4 d-flex flex-grow-1 justify-content-center py-5 flex-column">
          <div class="layout-content-container d-flex flex-column w-100">
              <h2 class="text-ink fs-4 fw-bold lh-sm px-4 pb-3 pt-5">@Localizer["EmailTemplateBuilder"]</h2>
            <div class="pb-3">
              <div class="d-flex border-bottom border border-soft px-4 gap-4">
                <a class="d-flex flex-column align-items-center justify-content-center border-bottom border-3 border-primary text-ink pb-3 pt-4" href="#" @onclick='() => activeTab = "Blocks"'>
                  <p class="text-ink small fw-bold lh-base">@Localizer["Blocks"]</p>
                </a>
                <a class="d-flex flex-column align-items-center justify-content-center border-bottom border-3 border-transparent text-ink-muted pb-3 pt-4" href="#" @onclick='() => activeTab = "Settings"'>
                  <p class="text-ink-muted small fw-bold lh-base">@Localizer["Settings"]</p>
                </a>
                <a class="d-flex flex-column align-items-center justify-content-center border-bottom border-3 border-transparent text-ink-muted pb-3 pt-4" href="#" @onclick='() => activeTab = "Preview"'>
                  <p class="text-ink-muted small fw-bold lh-base">@Localizer["Preview"]</p>
                </a>
              </div>
            </div>
              <h3 class="text-ink fs-4 fw-bold lh-sm px-4 pb-2 pt-4">@Localizer["BasicBlocks"]</h3>
              <div class="block-grid d-grid ui-grid-autofit gap-3 p-4">
                <div class="d-flex flex-grow-1 gap-3 rounded-3 border border-soft bg-surface-soft p-4 align-items-center" @onclick='() => AddBlock("Text")'>
                <div class="text-ink" data-icon="TextB" data-size="24px" data-weight="regular">
                  <svg xmlns="http://www.w3.org/2000/svg" width="24px" height="24px" fill="currentColor" viewBox="0 0 256 256">
                    <path
                      d="M170.48,115.7A44,44,0,0,0,140,40H72a8,8,0,0,0-8,8V200a8,8,0,0,0,8,8h80a48,48,0,0,0,18.48-92.3ZM80,56h60a28,28,0,0,1,0,56H80Zm72,136H80V128h72a32,32,0,0,1,0,64Z"
                    ></path>
                  </svg>
                </div>
                <h2 class="text-ink fs-5 fw-bold lh-sm">@Localizer["Text"]</h2>
              </div>
                <div class="d-flex flex-grow-1 gap-3 rounded-3 border border-soft bg-surface-soft p-4 align-items-center" @onclick='() => AddBlock("Image")'>
                <div class="text-ink" data-icon="Image" data-size="24px" data-weight="regular">
                  <svg xmlns="http://www.w3.org/2000/svg" width="24px" height="24px" fill="currentColor" viewBox="0 0 256 256">
                    <path
                      d="M216,40H40A16,16,0,0,0,24,56V200a16,16,0,0,0,16,16H216a16,16,0,0,0,16-16V56A16,16,0,0,0,216,40Zm0,16V158.75l-26.07-26.06a16,16,0,0,0-22.63,0l-20,20-44-44a16,16,0,0,0-22.62,0L40,149.37V56ZM40,172l52-52,80,80H40Zm176,28H194.63l-36-36,20-20L216,181.38V200ZM144,100a12,12,0,1,1,12,12A12,12,0,0,1,144,100Z"
                    ></path>
                  </svg>
                </div>
                <h2 class="text-ink fs-5 fw-bold lh-sm">@Localizer["Image"]</h2>
              </div>
                <div class="d-flex flex-grow-1 gap-3 rounded-3 border border-soft bg-surface-soft p-4 align-items-center" @onclick='() => AddBlock("Button")'>
                <div class="text-ink" data-icon="CursorClick" data-size="24px" data-weight="regular">
                  <svg xmlns="http://www.w3.org/2000/svg" width="24px" height="24px" fill="currentColor" viewBox="0 0 256 256">
                    <path
                      d="M169.64,134.33l44.77-19.46A16,16,0,0,0,213,85.07L52.92,32.8A16,16,0,0,0,32.8,52.92L85.07,213a15.83,15.83,0,0,0,14.41,11l.79,0a15.83,15.83,0,0,0,14.6-9.59h0l19.46-44.77L184,219.31a16,16,0,0,0,22.63,0l12.68-12.68a16,16,0,0,0,0-22.63Zm-69.48,73.76.06-.05Zm95.15-.09-49.66-49.67a16,16,0,0,0-26,4.94l-19.42,44.65L48,48l159.87,52.21-44.64,19.41a16,16,0,0,0-4.94,26L208,195.31ZM88,24V16a8,8,0,0,1,16,0v8a8,8,0,0,1-16,0ZM8,96a8,8,0,0,1,8-8h8a8,8,0,0,1,0,16H16A8,8,0,0,1,8,96ZM120.85,28.42l8-16a8,8,0,0,1,14.31,7.16l-8,16a8,8,0,1,1-14.31-7.16Zm-81.69,96a8,8,0,0,1-3.58,10.74l-16,8a8,8,0,0,1-7.16-14.31l16-8A8,8,0,0,1,39.16,124.42Z"
                    ></path>
                  </svg>
                </div>
                <h2 class="text-ink fs-5 fw-bold lh-sm">@Localizer["Button"]</h2>
              </div>
                <div class="d-flex flex-grow-1 gap-3 rounded-3 border border-soft bg-surface-soft p-4 align-items-center" @onclick='() => AddBlock("SocialLinks")'>
                <div class="text-ink" data-icon="FacebookLogo" data-size="24px" data-weight="regular">
                  <svg xmlns="http://www.w3.org/2000/svg" width="24px" height="24px" fill="currentColor" viewBox="0 0 256 256">
                    <path
                      d="M128,24A104,104,0,1,0,232,128,104.11,104.11,0,0,0,128,24Zm8,191.63V152h24a8,8,0,0,0,0-16H136V112a16,16,0,0,1,16-16h16a8,8,0,0,0,0-16H152a32,32,0,0,0-32,32v24H96a8,8,0,0,0,0,16h24v63.63a88,88,0,1,1,16,0Z"
                    ></path>
                  </svg>
                </div>
                <h2 class="text-ink fs-5 fw-bold lh-sm">@Localizer["SocialLinks"]</h2>
              </div>
            </div>
            <h3 class="text-ink fs-4 fw-bold lh-sm px-4 pb-2 pt-4">@Localizer["AdvancedBlocks"]</h3>
            <div class="block-grid d-grid ui-grid-autofit gap-3 p-4">
              <div class="d-flex flex-grow-1 gap-3 rounded-3 border border-soft bg-surface-soft p-4 align-items-center" @onclick='() => AddBlock("Layout")'>
                <div class="text-ink" data-icon="Layout" data-size="24px" data-weight="regular">
                  <svg xmlns="http://www.w3.org/2000/svg" width="24px" height="24px" fill="currentColor" viewBox="0 0 256 256">
                    <path
                      d="M216,40H40A16,16,0,0,0,24,56V200a16,16,0,0,0,16,16H216a16,16,0,0,0,16-16V56A16,16,0,0,0,216,40Zm0,16V96H40V56ZM40,112H96v88H40Zm176,88H112V112H216v88Z"
                    ></path>
                  </svg>
                </div>
                <h2 class="text-ink fs-5 fw-bold lh-sm">@Localizer["Layout"]</h2>
              </div>
              <div class="d-flex flex-grow-1 gap-3 rounded-3 border border-soft bg-surface-soft p-4 align-items-center" @onclick='() => AddBlock("Divider")'>
                <div class="text-ink" data-icon="Divide" data-size="24px" data-weight="regular">
                  <svg xmlns="http://www.w3.org/2000/svg" width="24px" height="24px" fill="currentColor" viewBox="0 0 256 256">
                    <path
                      d="M224,128a8,8,0,0,1-8,8H40a8,8,0,0,1,0-16H216A8,8,0,0,1,224,128ZM128,80a16,16,0,1,0-16-16A16,16,0,0,0,128,80Zm0,96a16,16,0,1,0,16,16A16,16,0,0,0,128,176Z"
                    ></path>
                  </svg>
                </div>
                <h2 class="text-ink fs-5 fw-bold lh-sm">@Localizer["Divider"]</h2>
              </div>
              <div class="d-flex flex-grow-1 gap-3 rounded-3 border border-soft bg-surface-soft p-4 align-items-center" @onclick='() => AddBlock("Video")'>
                <div class="text-ink" data-icon="Video" data-size="24px" data-weight="regular">
                  <svg xmlns="http://www.w3.org/2000/svg" width="24px" height="24px" fill="currentColor" viewBox="0 0 256 256">
                    <path
                      d="M164.44,105.34l-48-32A8,8,0,0,0,104,80v64a8,8,0,0,0,12.44,6.66l48-32a8,8,0,0,0,0-13.32ZM120,129.05V95l25.58,17ZM216,40H40A16,16,0,0,0,24,56V168a16,16,0,0,0,16,16H216a16,16,0,0,0,16-16V56A16,16,0,0,0,216,40Zm0,128H40V56H216V168Zm16,40a8,8,0,0,1-8,8H32a8,8,0,0,1,0-16H224A8,8,0,0,1,232,208Z"
                    ></path>
                  </svg>
                </div>
                <h2 class="text-ink fs-5 fw-bold lh-sm">@Localizer["Video"]</h2>
              </div>
              <div class="d-flex flex-grow-1 gap-3 rounded-3 border border-soft bg-surface-soft p-4 align-items-center" @onclick='() => AddBlock("Product")'>
                <div class="text-ink" data-icon="X" data-size="24px" data-weight="regular">
                  <svg xmlns="http://www.w3.org/2000/svg" width="24px" height="24px" fill="currentColor" viewBox="0 0 256 256">
                    <path
                      d="M205.66,194.34a8,8,0,0,1-11.32,11.32L128,139.31,61.66,205.66a8,8,0,0,1-11.32-11.32L116.69,128,50.34,61.66A8,8,0,0,1,61.66,50.34L128,116.69l66.34-66.35a8,8,0,0,1,11.32,11.32L139.31,128Z"
                    ></path>
                  </svg>
                </div>
                <h2 class="text-ink fs-5 fw-bold lh-sm">@Localizer["Product"]</h2>
              </div>
            </div>
          </div>
          <div class="layout-content-container d-flex flex-column ui-max-w-960 flex-grow-1 w-100">
            <div class="d-flex flex-wrap justify-content-between gap-3 p-4">
              <div class="d-flex ui-min-w-18rem flex-column gap-3">
                <p class="text-ink fs-1 fw-bold lh-sm">@Localizer["NewEmailTemplate"]</p>
                <p class="text-ink-muted small fw-normal lh-base">@Localizer["DragAndDrop"]</p>
              </div>
            </div>
            <div class="d-flex flex-column p-4">
              <input class="mb-2 rounded-3 border border-soft px-2 py-1" @bind="Template.Subject" placeholder="@Localizer["Subject"]" />
              @if (!string.IsNullOrEmpty(validationMessage))
              {
                  <p class="text-red-600 small">@validationMessage</p>
              }
              @if (activeTab == "Preview")
              {
                  <div class="d-flex flex-column gap-2 rounded-3 border border-soft p-4">
                      <h3 class="fs-4 fw-bold">@Template.Subject</h3>
                      @foreach (var block in Template.Blocks)
                      {
                          <div class="border p-2">@block.Type: @block.Content</div>
                      }
                  </div>
              }
              else
              {
                  <div class="d-flex flex-column align-items-center gap-4 rounded-3 border border-2 border-dashed border-soft px-4 py-5">
                      @if (Template.Blocks.Count == 0)
                      {
                          <div class="d-flex ui-max-w-480 flex-column align-items-center gap-2">
                              <p class="text-ink fs-4 fw-bold lh-sm ui-max-w-480 text-center">@Localizer["DragAndDropHere"]</p>
                              <p class="text-ink small fw-normal lh-base ui-max-w-480 text-center">
                                @Localizer["StartBuilding"]
                              </p>
                          </div>
                      }
                      else
                      {
                          <div class="w-100">
                              @foreach (var item in Template.Blocks.Select((b, i) => new { Block = b, Index = i }))
                              {
                                  <div class="w-100 p-4 mb-2 bg-white border" draggable="true" @ondragstart="() => HandleDragStart(item.Index)" @ondrop="() => HandleDrop(item.Index)">
                                      <p class="fw-bold">@item.Block.Type</p>
                                  </div>
                              }
                          </div>
                      }
                    </div>
                }
              </div>
            <div class="d-flex justify-stretch">
              <div class="d-flex flex-grow-1 gap-3 flex-wrap px-4 py-3 justify-content-end">
                <button
                  class="d-flex ui-min-w-84px ui-max-w-480 align-items-center justify-content-center overflow-hidden rounded-3 ui-input-height px-4 bg-accent-soft text-ink small fw-bold lh-base"
                >
                  <span class="truncate">@Localizer["Cancel"]</span>
                </button>
                <button
                  class="d-flex ui-min-w-84px ui-max-w-480 align-items-center justify-content-center overflow-hidden rounded-3 ui-input-height px-4 bg-primary text-white small fw-bold lh-base"
                  @onclick="SaveTemplateAsync" disabled="@string.IsNullOrWhiteSpace(Template.Subject)">
                  <span class="truncate">@Localizer["SaveTemplate"]</span>
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

@code {
    [Parameter] public Guid? TemplateId { get; set; }

    private EmailTemplate Template = new();
    private string activeTab = "Blocks";
    private string? validationMessage;
    private int draggedIndex = -1;
    private bool isMenuOpen;

    protected override async System.Threading.Tasks.Task OnInitializedAsync()
    {
        if (TemplateId.HasValue)
        {
            var loaded = await TemplateService.LoadTemplateAsync(TemplateId.Value);
            if (loaded != null)
            {
                Template = loaded;
            }
        }
    }

    private void AddBlock(string type)
    {
        Template.Blocks.Add(new EmailBlock { Type = type });
    }

    private void HandleDragStart(int index) => draggedIndex = index;

    private void HandleDrop(int index)
    {
        if (draggedIndex < 0 || draggedIndex == index)
        {
            return;
        }

        var item = Template.Blocks[draggedIndex];
        Template.Blocks.RemoveAt(draggedIndex);
        Template.Blocks.Insert(index, item);
        draggedIndex = -1;
    }

    private void ToggleMenu() => isMenuOpen = !isMenuOpen;

    private async System.Threading.Tasks.Task SaveTemplateAsync()
    {
        validationMessage = null;
        if (string.IsNullOrWhiteSpace(Template.Subject))
        {
            validationMessage = Localizer["SubjectRequired"];
            return;
        }

        await TemplateService.SaveTemplateAsync(Template);
    }
}
