@page "/contacts"
@using Microsoft.Extensions.Localization
@inject IStringLocalizer<ContactsPage> Localizer
@using NexaCRM.UI.Services.Interfaces
@using ContactModel = NexaCRM.UI.Models.Contact
@using NexaCRM.UI.Models
@using NexaCRM.UI.Models.Enums
@using System.Linq
@using System.Security.Claims
@using Microsoft.AspNetCore.Components.Authorization
@inject IContactService ContactService
@inject IActivityService ActivityService
@inject NavigationManager NavigationManager
@inject AuthenticationStateProvider AuthStateProvider

<PageTitle>@Localizer["Contacts"]</PageTitle>

<div class="contacts-layout common-page-container">
    <div class="contacts-toolbar">
        <label class="contacts-search">
            <i class="bi bi-search" aria-hidden="true"></i>
            <input placeholder='@Localizer["Search"]'
                   @bind="searchQuery"
                   @oninput="OnSearchInput" />
        </label>
        <button class="contacts-toolbar__button" @onclick="CreateContact">
            <i class="bi bi-plus-circle" aria-hidden="true"></i>
            <span>@Localizer["NewContact"]</span>
        </button>
    </div>

    @if (filteredContacts == null)
    {
        <p class="contacts-loading"><em>@Localizer["Loading..."]</em></p>
    }
    else if (filteredContacts.Count == 0)
    {
        <div class="contacts-empty">
            <i class="bi bi-people" aria-hidden="true"></i>
            <p>@Localizer["NoContacts"]</p>
        </div>
    }
    else
    {
        <div class="contacts-table-container">
            <div class="contacts-table-wrapper">
                <table class="contacts-table responsive-table">
                    <thead>
                        <tr>
                            <th scope="col">@Localizer["Id"]</th>
                            <th scope="col">@Localizer["FirstName"]</th>
                            <th scope="col">@Localizer["LastName"]</th>
                            <th scope="col">@Localizer["Email"]</th>
                            <th scope="col">@Localizer["PhoneNumber"]</th>
                            <th scope="col">@Localizer["Actions"]</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var contact in filteredContacts)
                        {
                            <tr>
                                <td data-label="@Localizer["Id"]">@contact.Id</td>
                                <td data-label="@Localizer["FirstName"]">@contact.FirstName</td>
                                <td data-label="@Localizer["LastName"]">@contact.LastName</td>
                                <td data-label="@Localizer["Email"]">
                                    @if (!string.IsNullOrEmpty(contact.Email))
                                    {
                                        <a href="mailto:@contact.Email">@contact.Email</a>
                                    }
                                </td>
                                <td data-label="@Localizer["PhoneNumber"]">
                                    @if (!string.IsNullOrEmpty(contact.PhoneNumber))
                                    {
                                        <a href="tel:@contact.PhoneNumber">@contact.PhoneNumber</a>
                                    }
                                </td>
                                <td data-label="@Localizer["Actions"]">
                                    <NexaCRM.UI.Components.UI.QuickActionsComponent
                                        PhoneNumber="@contact.PhoneNumber"
                                        Email="@contact.Email"
                                        CustomerName="@($"{contact.FirstName} {contact.LastName}".Trim())"
                                        CustomerId="@contact.Id.ToString()"
                                        ShowLabels="false"
                                        CssClass="inline"
                                        OnActionCompletedWithContact="HandleQuickActionWithContact" />
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    }
</div>

@code {
    private List<ContactModel>? contacts;
    private List<ContactModel>? filteredContacts;
    private string searchQuery = string.Empty;
    private string? currentUserName;
    private Guid currentUserGuid;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            // Get current authenticated user's ID
            var authState = await AuthStateProvider.GetAuthenticationStateAsync();
            var user = authState.User;
            
            if (user.Identity?.IsAuthenticated == true)
            {
                var userIdClaim = user.FindFirst(ClaimTypes.NameIdentifier)?.Value;
                currentUserName = user.FindFirst(ClaimTypes.Name)?.Value 
                    ?? user.FindFirst(ClaimTypes.Email)?.Value 
                    ?? "Unknown User";
                
                if (!string.IsNullOrEmpty(userIdClaim) && Guid.TryParse(userIdClaim, out currentUserGuid))
                {
                    // Get only contacts assigned to current user
                    contacts = (await ContactService.GetContactsByUserAsync(currentUserGuid)).ToList();
                }
                else
                {
                    // Fallback to all contacts if user ID is not available
                    contacts = (await ContactService.GetContactsAsync()).ToList();
                }
            }
            else
            {
                contacts = new List<ContactModel>();
            }
            
            filteredContacts = contacts;
        }
        catch (Exception ex)
        {
            // Log error and show empty list
            Console.WriteLine($"Error loading contacts: {ex.Message}");
            contacts = new List<ContactModel>();
            filteredContacts = contacts;
        }
    }

    private void OnSearchInput(ChangeEventArgs e)
    {
        searchQuery = e.Value?.ToString() ?? string.Empty;
        ApplyFilter();
    }

    private void ApplyFilter()
    {
        if (contacts is null)
        {
            filteredContacts = null;
            return;
        }

        if (string.IsNullOrWhiteSpace(searchQuery))
        {
            filteredContacts = contacts;
            return;
        }

        var query = searchQuery.Trim();
        filteredContacts = contacts
            .Where(contact =>
                (!string.IsNullOrEmpty(contact.FirstName) && contact.FirstName.Contains(query, StringComparison.OrdinalIgnoreCase)) ||
                (!string.IsNullOrEmpty(contact.LastName) && contact.LastName.Contains(query, StringComparison.OrdinalIgnoreCase)) ||
                (!string.IsNullOrEmpty(contact.Email) && contact.Email.Contains(query, StringComparison.OrdinalIgnoreCase)) ||
                (!string.IsNullOrEmpty(contact.PhoneNumber) && contact.PhoneNumber.Contains(query, StringComparison.OrdinalIgnoreCase)))
            .ToList();
    }

    private async Task HandleQuickActionWithContact((string Action, string? ContactId) data)
    {
        try
        {
            if (string.IsNullOrEmpty(data.Action) || string.IsNullOrEmpty(data.ContactId))
            {
                return;
            }

            if (!int.TryParse(data.ContactId, out var contactId))
            {
                Console.WriteLine($"Invalid contact ID: {data.ContactId}");
                return;
            }

            // action: "call", "email", "meeting"
            var activityType = data.Action.ToLowerInvariant() switch
            {
                "call" => ActivityType.Call,
                "email" => ActivityType.Email,
                "meeting" => ActivityType.Meeting,
                _ => ActivityType.Note
            };

            // Create activity log
            var activity = new Activity
            {
                ContactId = contactId,
                Type = activityType,
                Content = $"{activityType} action performed via quick actions",
                Timestamp = DateTime.UtcNow,
                CreatedBy = currentUserName ?? "Unknown User"
            };

            // Save to database
            await ActivityService.AddActivityAsync(activity);
            
            Console.WriteLine($"Activity logged: {activityType} for contact {contactId} by {currentUserName}");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error handling quick action: {ex.Message}");
        }
    }

    private void CreateContact()
    {
        NavigationManager.NavigateTo("/contacts/new");
    }
}
