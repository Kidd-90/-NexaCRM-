@page "/user-registration-page"
@layout LoginLayout
@attribute [AllowAnonymous]
@using Microsoft.Extensions.Localization
@using NexaCRM.Services.Admin.Interfaces
@using NexaCRM.Services.Admin.Models
@inject IStringLocalizer<UserRegistrationPage> Localizer
@inject IOrganizationService OrganizationService
@inject NavigationManager NavigationManager

<div
      class="position-relative d-flex min-vh-100 flex-column overflow-x-hidden overflow-y-auto"
      style="--checkbox-tick-svg: url('data:image/svg+xml,%3csvg viewBox=%270 0 16 16%27 fill=%27rgb(248,250,252)%27 xmlns=%27http://www.w3.org/2000/svg%27%3e%3cpath d=%27M12.207 4.793a1 1 0 010 1.414l-5 5a1 1 0 01-1.414 0l-2-2a1 1 0 011.414-1.414L6.586 9.086l4.293-4.293a1 1 0 011.414 0z%27/%3e%3c/svg%3e')"
    >
      <div class="layout-container d-flex h-100 flex-grow-1 flex-column">
        <div class="d-flex flex-grow-1 align-items-center justify-content-center py-4 px-4">
          <div class="w-100 max-w-md mx-auto">
            <div class="register-card rounded-4 overflow-hidden border backdrop-blur-md">
              <div class="px-4 pb-8 pt-6">
                <div class="text-center mb-8">
                  <h2 class="register-header fs-4 fw-bold lh-sm mb-2">@Localizer["CreateYourAccount"]</h2>
                </div>
                <EditForm Model="@newUser" OnValidSubmit="OnValidSubmit">
                  <DataAnnotationsValidator />
                  <ValidationSummary />
                  @if (!string.IsNullOrEmpty(successMessage))
                  {
                      <div class="success-message border px-4 py-3 rounded position-relative mb-4" role="alert">
                          <span class="block">@successMessage</span>
                      </div>
                  }
                  @if (!string.IsNullOrEmpty(errorMessage))
                  {
                      <div class="error-message border px-4 py-3 rounded position-relative mb-4" role="alert">
                          <span class="block">@errorMessage</span>
                      </div>
                  }

                  <div class="mb-4">
                    <label class="d-flex flex-column">
                      <p class="register-form-label fs-5 fw-semibold lh-base pb-2">@Localizer["FullName"]</p>
                      <input @bind="newUser.FullName"
                        placeholder="@Localizer["EnterFullName"]"
                        class="register-form-input d-flex w-100 overflow-hidden rounded-3 border ui-input-height-lg px-4 fs-5 fw-normal lh-base" />
                      <ValidationMessage For="@(() => newUser.FullName)" />
                    </label>
                  </div>
                  <div class="mb-4">
                    <label class="d-flex flex-column">
                      <p class="register-form-label fs-5 fw-semibold lh-base pb-2">@Localizer["UserId"]</p>
                      <input @bind="newUser.UserId"
                        placeholder="@Localizer["EnterUserId"]"
                        class="register-form-input d-flex w-100 overflow-hidden rounded-3 border ui-input-height-lg px-4 fs-5 fw-normal lh-base" />
                      <p class="small text-slate-500 mt-1">@Localizer["UserIdRequirements"]</p>
                      <ValidationMessage For="@(() => newUser.UserId)" />
                    </label>
                  </div>
                  <div class="mb-4">
                    <label class="d-flex flex-column">
                      <p class="register-form-label fs-5 fw-semibold lh-base pb-2">@Localizer["Email"]</p>
                      <input @bind="newUser.Email"
                        placeholder="@Localizer["EnterEmail"]"
                        class="register-form-input d-flex w-100 overflow-hidden rounded-3 border ui-input-height-lg px-4 fs-5 fw-normal lh-base" />
                      <ValidationMessage For="@(() => newUser.Email)" />
                    </label>
                  </div>
                  <div class="mb-4">
                    <label class="d-flex flex-column">
                      <p class="register-form-label fs-5 fw-semibold lh-base pb-2">@Localizer["Password"]</p>
                      <input @bind="newUser.Password" type="password"
                        placeholder="@Localizer["EnterPassword"]"
                        class="register-form-input d-flex w-100 overflow-hidden rounded-3 border ui-input-height-lg px-4 fs-5 fw-normal lh-base" />
                      <p class="small text-slate-500 mt-1">@Localizer["PasswordRequirements"]</p>
                      <ValidationMessage For="@(() => newUser.Password)" />
                    </label>
                  </div>
                  <div class="mb-4">
                    <label class="d-flex flex-column">
                      <p class="register-form-label fs-5 fw-semibold lh-base pb-2">@Localizer["ConfirmPassword"]</p>
                      <input @bind="newUser.ConfirmPassword" type="password"
                        placeholder="@Localizer["ConfirmYourPassword"]"
                        class="register-form-input d-flex w-100 overflow-hidden rounded-3 border ui-input-height-lg px-4 fs-5 fw-normal lh-base" />
                      <ValidationMessage For="@(() => newUser.ConfirmPassword)" />
                    </label>
                  </div>
                  <div class="d-flex align-items-center gap-3 mb-6">
                    <input type="checkbox" class="register-checkbox rounded border border-2" style="accent-color: var(--primary-color);" @bind="newUser.TermsAccepted" />
                    <p class="register-form-label small fw-normal lh-base">@Localizer["AgreeToTerms"]</p>
                  </div>
                  <ValidationMessage For="@(() => newUser.TermsAccepted)" />

                  <div class="mb-4">
                    <button type="submit" class="register-button d-flex w-100 align-items-center justify-content-center overflow-hidden rounded-3 ui-input-height-lg text-white fs-5 fw-semibold lh-base">
                      <span class="truncate">@Localizer["CreateAccount"]</span>
                    </button>
                  </div>
                </EditForm>
                <div class="text-center">
                  <a href="/login" class="register-link small">@Localizer["AlreadyHaveAccount"]</a>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

@code {
    private NewUser newUser = new();
    private string? successMessage;
    private string? errorMessage;

    private async Task OnValidSubmit()
    {
        successMessage = errorMessage = null;
        try
        {
            await OrganizationService.RegisterUserAsync(newUser);
            successMessage = Localizer["RegistrationSuccessful"];
            await Task.Delay(2000);
            NavigationManager.NavigateTo("/login");
        }
        catch (Exception ex)
        {
            errorMessage = Localizer["RegistrationFailed", ex.Message];
        }
    }
}
