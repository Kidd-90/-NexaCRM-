@page "/db/customer/my-list"
@using System.Collections.Generic
@using System.Linq
@using Microsoft.Extensions.Localization
@using NexaCRM.Pages.Components.Shared
@using NexaCRM.Pages.Pages.Db.Shared
@using NexaCRM.Services.Admin.Models.Db

@inherits AgentDbCustomerListPageBase

@inject IStringLocalizer<DbStatus> StatusLocalizer

<PageTemplate PageTitle="ë‚´ DB ëª©ë¡"
              PageDescription="í˜„ì¬ ë‚˜ì—ê²Œ ë°°ì •ëœ ê³ ê° DBë¥¼ í™•ì¸í•˜ê³  ìƒì„¸ í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤."
              BodyCssClass="space-y-6"
              DisableCardSurface="true">
    <LeadingVisual>
        <span class="text-3xl" aria-hidden="true">ğŸ—‚ï¸</span>
    </LeadingVisual>

    <HeaderActions>
        <button type="button"
                class="inline-flex items-center gap-2 rounded-lg border border-[var(--border-color)] bg-[var(--surface-bg)] px-4 py-2 text-sm font-medium shadow-sm transition hover:bg-[var(--primary-bg)] disabled:opacity-60"
                @onclick="RefreshAsync"
                disabled="@IsLoading">
            <span aria-hidden="true">ğŸ”„</span>
            ìƒˆë¡œê³ ì¹¨
        </button>
    </HeaderActions>

    @if (IsLoading)
    {
        <div class="themed-surface-card border border-[var(--border-color)] rounded-xl p-10 text-center text-sm themed-text-secondary">
            ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...
        </div>
    }
    else if (!string.IsNullOrEmpty(ErrorMessage))
    {
        <div class="rounded-xl border border-rose-200 bg-rose-50 p-6 text-sm text-rose-600">
            @ErrorMessage
        </div>
    }
    else if (Customers.Count == 0)
    {
        <div class="rounded-xl border border-dashed border-[var(--border-color)] bg-[var(--surface-bg)] p-10 text-center text-sm themed-text-secondary">
            ë°°ì •ëœ DBê°€ ì—†ìŠµë‹ˆë‹¤.
        </div>
    }
    else
    {
        <div class="themed-surface-card border border-[var(--border-color)] rounded-xl shadow-sm">
            <div class="hidden overflow-x-auto md:block">
                <table class="min-w-full divide-y divide-[var(--border-color)] text-left text-sm">
                    <thead class="bg-[var(--surface-bg-muted)] text-xs uppercase tracking-wide themed-text-secondary">
                        <tr>
                            <th class="px-6 py-3">ê³ ê°ëª…</th>
                            <th class="px-6 py-3">ì—°ë½ì²˜</th>
                            <th class="px-6 py-3">ë¶„ë°°ì¼</th>
                            <th class="px-6 py-3">DB ìƒíƒœ</th>
                            <th class="px-6 py-3">ìµœì¢… ì»¨íƒ</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-[var(--border-color)]">
                        @foreach (var customer in Customers.OrderByDescending(c => c.AssignedDate))
                        {
                            <tr class="cursor-pointer transition hover:bg-[var(--primary-bg)]/40" @onclick="() => NavigateToContact(customer.ContactId)">
                                <td class="px-6 py-4 font-medium">@customer.CustomerName</td>
                                <td class="px-6 py-4">@customer.ContactNumber</td>
                                <td class="px-6 py-4">@customer.AssignedDate.ToShortDateString()</td>
                                <td class="px-6 py-4 @DbStatusCss.GetStatusTextClass(customer.Status)">@StatusLocalizer[customer.Status.ToString()]</td>
                                <td class="px-6 py-4">@customer.LastContactDate.ToShortDateString()</td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>

            <div class="space-y-4 border-t border-[var(--border-color)] p-4 md:hidden">
                @foreach (var customer in Customers.OrderByDescending(c => c.AssignedDate))
                {
                    <article class="rounded-xl border border-[var(--border-color)] bg-[var(--surface-bg)] p-4 shadow-sm" @onclick="() => NavigateToContact(customer.ContactId)">
                        <h3 class="text-base font-semibold themed-text-primary">@customer.CustomerName</h3>
                        <dl class="mt-3 space-y-2 text-sm">
                            <div class="flex justify-between">
                                <dt class="text-[var(--text-muted)]">ì—°ë½ì²˜</dt>
                                <dd>@customer.ContactNumber</dd>
                            </div>
                            <div class="flex justify-between">
                                <dt class="text-[var(--text-muted)]">ë¶„ë°°ì¼</dt>
                                <dd>@customer.AssignedDate.ToShortDateString()</dd>
                            </div>
                            <div class="flex justify-between">
                                <dt class="text-[var(--text-muted)]">DB ìƒíƒœ</dt>
                                <dd class="@DbStatusCss.GetStatusTextClass(customer.Status)">@StatusLocalizer[customer.Status.ToString()]</dd>
                            </div>
                            <div class="flex justify-between">
                                <dt class="text-[var(--text-muted)]">ìµœì¢… ì»¨íƒ</dt>
                                <dd>@customer.LastContactDate.ToShortDateString()</dd>
                            </div>
                        </dl>
                    </article>
                }
            </div>
        </div>
    }
</PageTemplate>

@code {
    protected override async Task<IEnumerable<DbCustomer>> FetchCustomersAsync()
    {
        var agentName = await ResolveAgentNameAsync();
        if (string.IsNullOrWhiteSpace(agentName))
        {
            return Array.Empty<DbCustomer>();
        }

        return await DbDataService.GetMyDbListAsync(agentName);
    }

    private void NavigateToContact(int contactId)
    {
        NavigationManager.NavigateTo($"/contacts/{contactId}");
    }
}
