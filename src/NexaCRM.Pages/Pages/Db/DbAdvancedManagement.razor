@page "/db/advanced-test"
@using System
@using System.Text
@using System.Threading
@using Microsoft.AspNetCore.Components
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.Extensions.Localization
@using Microsoft.JSInterop
@using NexaCRM.Pages.Components.Shared
@using NexaCRM.Pages.Components.Db
@using NexaCRM.Services.Admin.Interfaces
@using NexaCRM.Services.Admin.Models.Db
@inject IDbDataService DbDataService
@inject IDbAdminService DbAdminService
@inject IStringLocalizer<DbStatus> StatusLocalizer
@inject INotificationFeedService NotificationFeed
@inject IDuplicateService DuplicateService
@inject IDedupeConfigService DedupeConfig
@inject IJSRuntime JS
@implements IDisposable

<PageTemplate PageTitle="ê³ ê¸‰ DB ê´€ë¦¬"
              PageDescription="ì²´í—˜ ë°ì´í„°ë¥¼ ê¸°ë°˜ìœ¼ë¡œ íƒìƒ‰, ì¤‘ë³µ ê´€ë¦¬, êµ¬ë¶„ê°’ ìœ ì§€ ë³´ìˆ˜ê¹Œì§€ í•œ í™”ë©´ì—ì„œ ë‹¤ë£¹ë‹ˆë‹¤."
              BodyCssClass="space-y-6"
              DisableCardSurface="false">
    <LeadingVisual>
        <span class="text-3xl" aria-hidden="true">ğŸ“Š</span>
    </LeadingVisual>

    <MetaContent>
        <div class="flex items-center gap-2" role="status" aria-live="polite">
            <span class="inline-flex h-2 w-2 rounded-full bg-emerald-500" aria-hidden="true"></span>
            <span>ì‹¤ì‹œê°„ ë°ì´í„° ë™ê¸°í™” í™œì„±í™”</span>
        </div>
    </MetaContent>

    <HeaderActions>
        <div class="db-toolbar" role="group" aria-label="í˜ì´ì§€ ì•¡ì…˜">
            <button type="button" class="db-action-button" @onclick="SaveCurrentView" title="ê³§ ì œê³µ ì˜ˆì • ê¸°ëŠ¥ì…ë‹ˆë‹¤.">
                <span aria-hidden="true">ğŸ”–</span>
                ë³´ê¸° ì €ì¥
            </button>
            <button type="button" class="db-action-button" disabled>
                <span aria-hidden="true">ğŸ§±</span>
                ì»¬ëŸ¼
            </button>
            <button type="button" class="db-action-button" disabled>
                <span aria-hidden="true">ğŸ§¾</span>
                ì¼ê´„ ì‘ì—…
            </button>
            <button type="button" class="db-action-button" @onclick="ExportCsv" disabled="@isExporting">
                <span aria-hidden="true">â¬‡ï¸</span>
                ë‚´ë³´ë‚´ê¸°
            </button>
            <label class="db-action-button db-action-button--primary" for="importFile" title="ê³§ ì œê³µ ì˜ˆì • ê¸°ëŠ¥ì…ë‹ˆë‹¤.">
                <span aria-hidden="true">â•</span>
                ê³ ê° DB ì¶”ê°€í•˜ê¸°
            </label>
            <input id="importFile" type="file" accept=".xlsx,.xls,.csv" class="hidden" @onchange="OnImportFileSelected" />
        </div>
    </HeaderActions>

    <DescriptionContent>
        <p class="themed-text-secondary">CSV ë‚´ë³´ë‚´ê¸°ì™€ ì‚­ì œëŠ” ì‹¤ì œë¡œ ìˆ˜í–‰ë˜ë©°, ë‚˜ë¨¸ì§€ ê³ ê¸‰ ê¸°ëŠ¥ì€ ë¹ ë¥´ê²Œ ì‹œì—°í•  ìˆ˜ ìˆë„ë¡ ë¯¸ë¦¬ êµ¬ì„±ë˜ì–´ ìˆìŠµë‹ˆë‹¤.</p>
    </DescriptionContent>

    <ChildContent>
    <div class="db-preview-banner" role="status" aria-live="polite">
        <span aria-hidden="true">â„¹ï¸</span>
        <span>ì²´í—˜ ë°ì´í„° ê¸°ë°˜ìœ¼ë¡œ ë™ì‘í•©ë‹ˆë‹¤. CSV ë‚´ë³´ë‚´ê¸°ì™€ ì‚­ì œëŠ” ì‹¤ì œë¡œ ìˆ˜í–‰ë©ë‹ˆë‹¤.</span>
    </div>

    <nav class="db-tabs" role="tablist">
        <button type="button" class="@TabClass(Tab.Explore)" @onclick="(() => SetTab(Tab.Explore))">ëª©ë¡</button>
        <button type="button" class="@TabClass(Tab.Segments)" @onclick="(() => SetTab(Tab.Segments))">ì„¸ê·¸ë¨¼íŠ¸</button>
        <button type="button" class="@TabClass(Tab.Imports)" @onclick="(() => SetTab(Tab.Imports))">ê°€ì ¸ì˜¤ê¸°</button>
        <button type="button" class="@TabClass(Tab.Dedupe)" @onclick="(() => SetTab(Tab.Dedupe))">ì¤‘ë³µ ê´€ë¦¬</button>
        <button type="button" class="@TabClass(Tab.Grade)" @onclick="(() => SetTab(Tab.Grade))">ë“±ê¸‰ ê´€ë¦¬</button>
        <button type="button" class="@TabClass(Tab.Consult)" @onclick="(() => SetTab(Tab.Consult))">ìƒë‹´ êµ¬ë¶„ê°’</button>
        <button type="button" class="@TabClass(Tab.Distribution)" @onclick="(() => SetTab(Tab.Distribution))">ë¶„ë°°ì„¤ì •</button>
        <button type="button" class="@TabClass(Tab.Settings)" @onclick="(() => SetTab(Tab.Settings))">ì„¤ì •</button>
    </nav>

    <div class="advanced-db">
        @if (activeTab == Tab.Explore)
        {
            <section class="explore">
            <aside class="filters">
                <div class="filter-group">
                    <label>ìƒíƒœ</label>
                    <select class="form-select" @bind="filterStatus" @bind:after="ApplyFiltersAfter">
                        <option value="">ì „ì²´</option>
                        @foreach (var s in Enum.GetValues<DbStatus>())
                        {
                            <option value="@s">@StatusLocalizer[s.ToString()]</option>
                        }
                    </select>
                </div>
                <div class="filter-group">
                    <label>ë¶„ë°°ì¼(ì‹œì‘)</label>
                    <input class="form-control" type="date" @bind="filterFrom" @bind:after="ApplyFiltersAfter" />
                </div>
                <div class="filter-group">
                    <label>ë¶„ë°°ì¼(ì¢…ë£Œ)</label>
                    <input class="form-control" type="date" @bind="filterTo" @bind:after="ApplyFiltersAfter" />
                </div>
                <div class="filter-group">
                    <label>ê²€ìƒ‰</label>
                    <input class="form-control" placeholder="ì´ë¦„/ì—°ë½ì²˜" value="@search" @oninput="OnSearchChanged" />
                </div>
            </aside>

            <div class="grid">
                <div class="table-responsive">
                    <table class="table table-hover align-middle">
                        <thead class="table-light">
                            <tr>
                                <th>ê³ ê°ëª…</th>
                                <th>ì—°ë½ì²˜</th>
                                <th>ê·¸ë£¹</th>
                                <th>ë‹´ë‹¹ì</th>
                                <th>ë¶„ë°°ì¼</th>
                                <th>ìƒíƒœ</th>
                                <th>ìµœì¢… ì»¨íƒì¼</th>
                                <th class="text-end">ì‘ì—…</th>
                            </tr>
                        </thead>
                        <tbody>
                            @if (isLoading)
                            {
                                <tr>
                                    <td colspan="8" class="text-center text-muted">
                                        <div class="db-loading" role="status" aria-live="polite">
                                            <span class="db-spinner" aria-hidden="true"></span>
                                            <span>ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</span>
                                        </div>
                                    </td>
                                </tr>
                            }
                            else if (filtered.Count > 0)
                            {
                                @foreach (var c in filtered)
                                {
                                    <tr data-contact-id="@c.ContactId">
                                        <td>@c.CustomerName</td>
                                        <td>@c.ContactNumber</td>
                                        <td>@c.Group</td>
                                        <td>@c.AssignedTo</td>
                                        <td>@c.AssignedDate.ToShortDateString()</td>
                                        <td class="@GetStatusClass(c.Status)">@StatusLocalizer[c.Status.ToString()]</td>
                                        <td>@c.LastContactDate.ToShortDateString()</td>
                                        <td class="text-end">
                                            <span class="text-muted" title="ì‚­ì œ ê¸°ëŠ¥ì€ Blazor 8 ë²„ê·¸ë¡œ ì¸í•´ ì„ì‹œ ë¹„í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤">ğŸ—‘ï¸</span>
                                        </td>
                                    </tr>
                                }
                            }
                            else
                            {
                                <tr><td colspan="8" class="text-center text-muted">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </section>
    }
    else if (activeTab == Tab.Segments)
    {
            <section class="placeholder">
                <h5>ì„¸ê·¸ë¨¼íŠ¸</h5>
                <p>ì¡°ê±´ì‹ ê¸°ë°˜ ë™ì  ì„¸ê·¸ë¨¼íŠ¸ì™€ ì •ì  ì„¸ê·¸ë¨¼íŠ¸ë¥¼ ìƒì„±/ê´€ë¦¬í•©ë‹ˆë‹¤.</p>
            </section>
        }
        else if (activeTab == Tab.Imports)
        {
            <section class="placeholder">
                <h5>ê°€ì ¸ì˜¤ê¸° ê¸°ë¡</h5>
                <p>ì—…ë¡œë“œí•œ íŒŒì¼, ë§¤í•‘, ìœ íš¨ì„± ê²€ì‚¬ ê²°ê³¼ ë° ì˜¤ë¥˜ ë¦¬í¬íŠ¸ë¥¼ í™•ì¸í•©ë‹ˆë‹¤.</p>
            </section>
        }
        else if (activeTab == Tab.Dedupe)
        {
            <section class="dedupe">
            <div class="dedupe-controls">
                <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="dedupeEnabled" @bind="dedupeEnabled" @bind:after="RecomputeDuplicatesAfter">
                    <label class="form-check-label" for="dedupeEnabled">ì¤‘ë³µ ê°ì§€ ì‚¬ìš©</label>
                </div>
                <div class="period">
                    <label for="dedupeDays" class="form-label">ê¸°ê°„(ì¼)</label>
                    <input id="dedupeDays" type="number" class="form-control" style="max-width: 120px;" min="1" max="365" @bind="dedupeDays" @bind:after="RecomputeDuplicatesAfter" />
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="includeFuzzy" @bind="includeFuzzy" @bind:after="RecomputeDuplicatesAfter">
                    <label class="form-check-label" for="includeFuzzy">ìœ ì‚¬ ì¼ì¹˜ í¬í•¨</label>
                </div>
                <div class="period">
                    <label for="scoreThreshold" class="form-label">ì„ê³„ì¹˜(0-100)</label>
                    <input id="scoreThreshold" type="number" class="form-control" style="max-width: 120px;" min="0" max="100" @bind="scoreThreshold" @bind:after="RecomputeDuplicatesAfter" />
                </div>
                @if (dedupeEnabled)
                {
                    <div class="hint text-muted">ìµœê·¼ @dedupeDays ì¼ ë‚´ ë¶„ë°°ëœ í•­ëª©ì—ì„œ ì—°ë½ì²˜ ê¸°ì¤€ ì¤‘ë³µì„ ê²€ì‚¬í•©ë‹ˆë‹¤.</div>
                }
            </div>

            <AuthorizeView Roles="Manager">
            <details class="rule-config">
                <summary>ê·œì¹™ ì„¤ì •(ê°€ë³€ í•­ëª© ì‚¬ìš©/ê°€ì¤‘ì¹˜)</summary>
                <div class="rule-grid">
                    @RuleRow("ì„±ë³„", nameof(DedupeConfig.UseGender), () => UseGender, v => UseGender = v, nameof(DedupeConfig.WeightGender), () => WeightGender, v => WeightGender = v)
                    @RuleRow("ì£¼ì†Œ", nameof(DedupeConfig.UseAddress), () => UseAddress, v => UseAddress = v, nameof(DedupeConfig.WeightAddress), () => WeightAddress, v => WeightAddress = v)
                    @RuleRow("ì§ì—…", nameof(DedupeConfig.UseJobTitle), () => UseJobTitle, v => UseJobTitle = v, nameof(DedupeConfig.WeightJobTitle), () => WeightJobTitle, v => WeightJobTitle = v)
                    @RuleRow("ê²°í˜¼ì—¬ë¶€", nameof(DedupeConfig.UseMaritalStatus), () => UseMaritalStatus, v => UseMaritalStatus = v, nameof(DedupeConfig.WeightMaritalStatus), () => WeightMaritalStatus, v => WeightMaritalStatus = v)
                    @RuleRow("ë‚©ì…/ì¦ë¹™ë²ˆí˜¸", nameof(DedupeConfig.UseProofNumber), () => UseProofNumber, v => UseProofNumber = v, nameof(DedupeConfig.WeightProofNumber), () => WeightProofNumber, v => WeightProofNumber = v)
                    @RuleRow("DBê°€ê²©", nameof(DedupeConfig.UseDbPrice), () => UseDbPrice, v => UseDbPrice = v, nameof(DedupeConfig.WeightDbPrice), () => WeightDbPrice, v => WeightDbPrice = v)
                    @RuleRow("ë³¸ì‚¬", nameof(DedupeConfig.UseHeadquarters), () => UseHeadquarters, v => UseHeadquarters = v, nameof(DedupeConfig.WeightHeadquarters), () => WeightHeadquarters, v => WeightHeadquarters = v)
                    @RuleRow("ë³´í—˜ëª…", nameof(DedupeConfig.UseInsuranceName), () => UseInsuranceName, v => UseInsuranceName = v, nameof(DedupeConfig.WeightInsuranceName), () => WeightInsuranceName, v => WeightInsuranceName = v)
                    @RuleRow("ìë™ì°¨ê°€ì…ì¼", nameof(DedupeConfig.UseCarJoinDate), () => UseCarJoinDate, v => UseCarJoinDate = v, nameof(DedupeConfig.WeightCarJoinDate), () => WeightCarJoinDate, v => WeightCarJoinDate = v)
                    @RuleRow("ë©”ëª¨", nameof(DedupeConfig.UseNotes), () => UseNotes, v => UseNotes = v, nameof(DedupeConfig.WeightNotes), () => WeightNotes, v => WeightNotes = v)
                </div>
            </details>
            </AuthorizeView>

            <aside class="dedupe-info" aria-live="polite">
                <h6 class="mb-2">ì¤‘ë³µ ê²€ì‚¬ ê¸°ì¤€ ì•ˆë‚´</h6>
                <p class="text-muted mb-2">ì´ë¯¸ì§€ì™€ ê°™ì´ í•­ëª© ì„¤ì •(ê³ ì •/ê°€ë³€)ì„ ê¸°ì¤€ìœ¼ë¡œ ì¤‘ë³µì„ íŒë‹¨í•©ë‹ˆë‹¤. ê¸°ë³¸ ê·œì¹™ì€ ì•„ë˜ì™€ ê°™ìŠµë‹ˆë‹¤.</p>
                <ul class="info-list">
                    <li><strong>í•„ìˆ˜ í•­ëª©(ê³ ì •)</strong>
                        <ul>
                            <li>ì´ë¦„: ê¸°ë³¸ì€ ì •í™• ì¼ì¹˜, <em>ìœ ì‚¬ ì¼ì¹˜ í¬í•¨</em> í™œì„±í™” ì‹œ ì´ë¦„ ì• 2ì ê¸°ì¤€ ë³´ì¡° ë§¤ì¹­ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.</li>
                            <li>ì—°ë½ì²˜: ìˆ«ìë§Œ ë‚¨ê²¨ ì •ê·œí™”(í•˜ì´í”ˆ/ê³µë°±/êµ­ê°€ì½”ë“œ ì œê±°) í›„ ë¹„êµí•©ë‹ˆë‹¤. ì •í™• ì¼ì¹˜ê°€ ìµœìš°ì„  í‚¤ì…ë‹ˆë‹¤.</li>
                        </ul>
                    </li>
                    <li><strong>ì¶”ê°€ í•­ëª©(ê°€ë³€)</strong>
                        <div class="muted-small">ì„±ë³„, ì£¼ì†Œ, ì§ì—…, ê²°í˜¼ì—¬ë¶€, ë‚©ì…/ì¦ë¹™ë²ˆí˜¸, DBê°€ê²©, ë³¸ì‚¬, ë³´í—˜ëª…, ìë™ì°¨ê°€ì…ì¼, ë©”ëª¨ ë“±</div>
                        <div>ì‚¬ìš©ì—¬ë¶€ê°€ <strong>ON</strong>ì¸ í•­ëª©ì€ ë³´ì¡° ìŠ¤ì½”ì–´ë¡œ ì‚¬ìš©ë˜ì–´ ì¼ì¹˜/ìœ ì‚¬ ì‹œ ìš°ì„ ìˆœìœ„ê°€ ë†’ì•„ì§‘ë‹ˆë‹¤. (í˜„ì¬ í™”ë©´ì€ ì•ˆë‚´ìš©ì´ë©°, ì„¸ë¶€ ê°€ì¤‘ì¹˜ëŠ” ê´€ë¦¬ ë©”ë‰´ì—ì„œ ì¡°ì • ê°€ëŠ¥í•˜ë„ë¡ í™•ì¥ ì˜ˆì •)</div>
                    </li>
                    <li><strong>íŒì • ë¡œì§</strong>
                        <ul>
                            <li>1ì°¨ í‚¤: ì—°ë½ì²˜ ì •ê·œí™” <span class="badge bg-secondary">ì •í™• ì¼ì¹˜</span></li>
                            <li>2ì°¨ í‚¤(ì˜µì…˜): ì´ë¦„ 2ì + ì—°ë½ì²˜ ë 4ìë¦¬ <span class="badge bg-info text-dark">ìœ ì‚¬ ì¼ì¹˜</span></li>
                            <li>ë³´ì¡° ì ìˆ˜: ì¶”ê°€ í•­ëª© ì‚¬ìš©ì—¬ë¶€ ON í•­ëª©ì˜ ì¼ì¹˜/ë¶ˆì¼ì¹˜</li>
                        </ul>
                    </li>
                </ul>
            </aside>

            <div class="grid">
                <div class="table-responsive">
                    <table class="table table-hover align-middle">
                        <thead class="table-light">
                            <tr>
                                <th>ì—°ë½ì²˜</th>
                                <th>ê±´ìˆ˜</th>
                                <th>ìŠ¤ì½”ì–´</th>
                                <th>ìµœê·¼ ë¶„ë°°ì¼</th>
                                <th>ëŒ€í‘œ ê³ ê°ëª…</th>
                                <th>ì•¡ì…˜</th>
                            </tr>
                        </thead>
                        <tbody>
                            @if (!dedupeEnabled)
                            {
                                <tr><td colspan="5" class="text-muted text-center">ì¤‘ë³µ ê°ì§€ê°€ ë¹„í™œì„±í™”ë˜ì–´ ìˆìŠµë‹ˆë‹¤.</td></tr>
                            }
                            else if (duplicates?.Any() == true)
                            {
                                @foreach (var g in duplicates)
                                {
                                    var group = g; // ë¡œì»¬ ë³€ìˆ˜ë¡œ ìº¡ì²˜í•˜ì—¬ Blazor 8 ë²„ê·¸ íšŒí”¼
                                    <tr>
                                        <td>@group.ContactDisplay</td>
                                        <td>@group.Count</td>
                                        <td>@($"{group.Score}%")</td>
                                        <td>@group.LatestAssigned.ToShortDateString()</td>
                                        <td>@group.SampleName</td>
                                        <td class="action-cell">
                                            <span class="text-muted me-2" title="ì¤‘ë³µ ê´€ë¦¬ ê¸°ëŠ¥ì€ Blazor 8 ë²„ê·¸ë¡œ ì¸í•´ ì„ì‹œ ë¹„í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤">
                                                <span aria-hidden="true">âš ï¸</span> ê´€ë¦¬ì ì•Œë¦¼
                                            </span>
                                            <span class="text-muted me-2" title="ì¤‘ë³µ ê´€ë¦¬ ê¸°ëŠ¥ì€ Blazor 8 ë²„ê·¸ë¡œ ì¸í•´ ì„ì‹œ ë¹„í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤">
                                                <span aria-hidden="true">ğŸ“</span> ë³´ê´€ ì²˜ë¦¬
                                            </span>
                                            <span class="text-muted me-2" title="ì¤‘ë³µ ê´€ë¦¬ ê¸°ëŠ¥ì€ Blazor 8 ë²„ê·¸ë¡œ ì¸í•´ ì„ì‹œ ë¹„í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤">
                                                <span aria-hidden="true">ğŸ—‘ï¸</span> ì‚­ì œ
                                            </span>
                                            <select class="form-select form-select-sm d-inline-block" style="width: auto;" disabled title="ì¤‘ë³µ ê´€ë¦¬ ê¸°ëŠ¥ì€ Blazor 8 ë²„ê·¸ë¡œ ì¸í•´ ì„ì‹œ ë¹„í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤">
                                                @foreach (var c in group.Candidates)
                                                {
                                                    <option value="@c.ContactId">@c.CustomerName (@c.ContactId)</option>
                                                }
                                            </select>
                                            <span class="text-muted" title="ì¤‘ë³µ ê´€ë¦¬ ê¸°ëŠ¥ì€ Blazor 8 ë²„ê·¸ë¡œ ì¸í•´ ì„ì‹œ ë¹„í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤">
                                                <span aria-hidden="true">ğŸ”—</span> ë³‘í•©
                                            </span>
                                        </td>
                                    </tr>
                                }
                            }
                            else
                            {
                                <tr><td colspan="5" class="text-muted text-center">ì¤‘ë³µ í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
            @if (showMergeModal && modalGroup is not null)
            {
                <div class="modal-backdrop">
                    <div class="modal-panel">
                        <header class="modal-header">
                            <h5>ì¤‘ë³µ ë³‘í•©</h5>
                        </header>
                        <div class="modal-body">
                            <p class="text-muted">ëŒ€í‘œ ë ˆì½”ë“œë¥¼ ì„ íƒí•˜ì„¸ìš”. ì„ íƒëœ ë ˆì½”ë“œë¥¼ ë‚¨ê¸°ê³  ë‚˜ë¨¸ì§€ëŠ” ë³‘í•© ì²˜ë¦¬ë©ë‹ˆë‹¤.</p>
                            <table class="table table-sm">
                                <thead class="table-light">
                                    <tr><th>ëŒ€í‘œ</th><th>ê³ ê°ëª…</th><th>ì—°ë½ì²˜</th><th>ë¶„ë°°ì¼</th></tr>
                                </thead>
                                <tbody>
                                @foreach (var c in modalGroup.Candidates.OrderByDescending(x => x.AssignedDate))
                                {
                                    <tr>
                                        <td>
                                            <input type="radio" name="primaryRadio" value="@c.ContactId" @onchange="(e=> modalPrimaryId = c.ContactId)" checked="@(modalPrimaryId==c.ContactId)" />
                                        </td>
                                        <td>@c.CustomerName</td>
                                        <td>@modalGroup.ContactDisplay</td>
                                        <td>@c.AssignedDate.ToShortDateString()</td>
                                    </tr>
                                }
                                </tbody>
                            </table>

                            <h6 class="mt-3">í•„ë“œë³„ ìš°ì„ ê°’ ì„ íƒ(ì„ íƒì‚¬í•­)</h6>
                            <div class="rule-grid" style="grid-template-columns: 1fr auto;">
                                @FieldSelectRow("ì„±ë³„", "Gender")
                                @FieldSelectRow("ì£¼ì†Œ", "Address")
                                @FieldSelectRow("ì§ì—…", "JobTitle")
                                @FieldSelectRow("ê²°í˜¼ì—¬ë¶€", "MaritalStatus")
                                @FieldSelectRow("ì¦ë¹™ë²ˆí˜¸", "ProofNumber")
                                @FieldSelectRow("DBê°€ê²©", "DbPrice")
                                @FieldSelectRow("ë³¸ì‚¬", "Headquarters")
                                @FieldSelectRow("ë³´í—˜ëª…", "InsuranceName")
                                @FieldSelectRow("ìë™ì°¨ê°€ì…ì¼", "CarJoinDate")
                                @FieldSelectRow("ë©”ëª¨", "Notes")
                            </div>
                        </div>
                        <footer class="modal-footer">
                            <button type="button" class="btn btn-light" @onclick="CloseMergeModal">ì·¨ì†Œ</button>
                            <button type="button" class="btn btn-primary" @onclick="ConfirmMergeModal">ë³‘í•© ì‹¤í–‰</button>
                        </footer>
                    </div>
                </div>
            }
            </section>
        }
        else if (activeTab == Tab.Grade)
        {
            <section class="grade-management">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5>ë“±ê¸‰ êµ¬ë¶„ê°’ ê´€ë¦¬</h5>
                <button type="button" class="btn btn-primary" @onclick="AddGradeRow"><span aria-hidden="true">â•</span> ë“±ê¸‰êµ¬ë¶„ê°’ ë“±ë¡</button>
            </div>
            <div class="table-responsive">
                <table class="table table-hover align-middle">
                    <thead class="table-light">
                        <tr>
                            <th>NO</th>
                            <th>êµ¬ë¶„ê°’ëª…</th>
                            <th>ìƒì„¸ì„¤ëª…</th>
                            <th>ì‚¬ìš©ì—¬ë¶€</th>
                            <th>ìµœì´ˆë“±ë¡ì¼ì‹œ</th>
                            <th>ìµœì¢…ìˆ˜ì •ì¼ì‹œ</th>
                            <th>ì•¡ì…˜</th>
                        </tr>
                    </thead>
                    <tbody>
                        @if (gradeRows.Any())
                        {
                            @foreach (var row in gradeRows.OrderByDescending(r => r.Id))
                            {
                                var currentRow = row; // ë¡œì»¬ ë³€ìˆ˜ë¡œ ìº¡ì²˜
                                <tr>
                                    <td>@currentRow.Id</td>
                                    <td><input class="form-control" @bind="currentRow.Name" /></td>
                                    <td><input class="form-control" @bind="currentRow.Description" /></td>
                                    <td>
                                        <select class="form-select" @bind="currentRow.IsActive">
                                            <option value="true">ì‚¬ìš©ì¤‘</option>
                                            <option value="false">ë¯¸ì‚¬ìš©</option>
                                        </select>
                                    </td>
                                    <td>@currentRow.CreatedAt.ToString("yyyy-MM-dd HH:mm:ss")</td>
                                    <td>@(currentRow.UpdatedAt.HasValue ? currentRow.UpdatedAt.Value.ToString("yyyy-MM-dd HH:mm:ss") : "-")</td>
                                    <td>
                                        <span class="text-muted" title="ë“±ê¸‰ ê´€ë¦¬ ê¸°ëŠ¥ì€ Blazor 8 ë²„ê·¸ë¡œ ì¸í•´ ì„ì‹œ ë¹„í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤"><span aria-hidden="true">ğŸ—‘ï¸</span></span>
                                    </td>
                                </tr>
                            }
                        }
                        else
                        {
                            <tr><td colspan="7" class="text-center text-muted">ë“±ê¸‰ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>
                        }
                    </tbody>
                </table>
            </div>
            <div class="mt-3 text-end">
                <button type="button" class="btn btn-success preview-action" @onclick="SaveGradeRows" title="ê³§ ì œê³µ ì˜ˆì • ê¸°ëŠ¥ì…ë‹ˆë‹¤."><span aria-hidden="true">ğŸ’¾</span> ë“±ê¸‰êµ¬ë¶„ê°’ ì €ì¥</button>
            </div>
            </section>
        }
        else if (activeTab == Tab.Consult)
        {
            <section class="consult-management">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5>ìƒë‹´ êµ¬ë¶„ê°’ ê´€ë¦¬</h5>
                <button type="button" class="btn btn-primary" @onclick="AddConsultRow"><span aria-hidden="true">â•</span> ìƒë‹´êµ¬ë¶„ê°’ ë“±ë¡</button>
            </div>
            <div class="table-responsive">
                <table class="table table-hover align-middle">
                    <thead class="table-light">
                        <tr>
                            <th>NO</th>
                            <th>ìƒíƒœê°’ëª…</th>
                            <th>ì •ì‚°ì‚¬ìš©ì—¬ë¶€</th>
                            <th>ìƒë‹´ì™„ë£Œì—¬ë¶€</th>
                            <th>ì‚¬ìš©ì—¬ë¶€</th>
                            <th>ìµœì´ˆë“±ë¡ì¼ì‹œ</th>
                            <th>ìµœì¢…ìˆ˜ì •ì¼ì‹œ</th>
                            <th>ìˆœì„œ</th>
                            <th>ì•¡ì…˜</th>
                        </tr>
                    </thead>
                    <tbody>
                        @if (consultRows.Any())
                        {
                            @foreach (var row in consultRows.OrderByDescending(r => r.Id))
                            {
                                var currentRow = row; // ë¡œì»¬ ë³€ìˆ˜ë¡œ ìº¡ì²˜
                                <tr>
                                    <td>@currentRow.Id</td>
                                    <td><input class="form-control" @bind="currentRow.Name" /></td>
                                    <td>
                                        <select class="form-select" @bind="currentRow.IsSettlement">
                                            <option value="true">ì‚¬ìš©ì¤‘</option>
                                            <option value="false">ë¯¸ì‚¬ìš©</option>
                                        </select>
                                    </td>
                                    <td>
                                        <select class="form-select" @bind="currentRow.IsComplete">
                                            <option value="true">ì™„ë£Œê°’</option>
                                            <option value="false">ê¸°ë³¸ê°’</option>
                                        </select>
                                    </td>
                                    <td>
                                        <select class="form-select" @bind="currentRow.IsActive">
                                            <option value="true">ì‚¬ìš©ì¤‘</option>
                                            <option value="false">ë¯¸ì‚¬ìš©</option>
                                        </select>
                                    </td>
                                    <td>@currentRow.CreatedAt.ToString("yyyy-MM-dd HH:mm:ss")</td>
                                    <td>@(currentRow.UpdatedAt.HasValue ? currentRow.UpdatedAt.Value.ToString("yyyy-MM-dd HH:mm:ss") : "-")</td>
                                    <td><input class="form-control" type="number" min="1" @bind="currentRow.Order" style="width:80px;" /></td>
                                    <td>
                                        <span class="text-muted" title="ìƒë‹´ êµ¬ë¶„ê°’ ê´€ë¦¬ ê¸°ëŠ¥ì€ Blazor 8 ë²„ê·¸ë¡œ ì¸í•´ ì„ì‹œ ë¹„í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤"><span aria-hidden="true">ğŸ—‘ï¸</span></span>
                                    </td>
                                </tr>
                            }
                        }
                        else
                        {
                            <tr><td colspan="9" class="text-center text-muted">ìƒë‹´ êµ¬ë¶„ê°’ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>
                        }
                    </tbody>
                </table>
            </div>
            <div class="mt-3 text-end">
                <button type="button" class="btn btn-success preview-action" @onclick="SaveConsultRows" title="ê³§ ì œê³µ ì˜ˆì • ê¸°ëŠ¥ì…ë‹ˆë‹¤."><span aria-hidden="true">ğŸ’¾</span> ìƒë‹´êµ¬ë¶„ê°’ ì €ì¥</button>
            </div>
            </section>
        }
        else if (activeTab == Tab.Distribution)
        {
            <section class="distribution-settings">
            <h5 class="mb-3">íŒ€ë³„ ë¶„ë°°ì„¤ì •</h5>
            <div class="d-flex align-items-center mb-2">
                <span class="me-2">íŒ€ë¶„ë°° ì„¤ì • (íŒ€ëª…/ìš°ì„ ìˆœìœ„/ê¸°ë³¸ìˆ˜ëŸ‰)</span>
                <div class="form-check form-switch ms-auto">
                    <input class="form-check-input" type="checkbox" id="autoDistTeam" @bind="autoDistTeam" />
                    <label class="form-check-label" for="autoDistTeam">ìë™ ë¶„ë°°</label>
                </div>
            </div>
            <div class="row mb-4">
                @foreach (var team in teamRows)
                {
                    <div class="col-md-3 mb-2">
                        <div class="input-group">
                            <span class="input-group-text">@team.Name</span>
                            <span class="input-group-text">@team.Code</span>
                            <span class="input-group-text">@team.Priority<span>ìœ„</span></span>
                            <input type="number" class="form-control" min="0" @bind="team.Quantity" />
                        </div>
                    </div>
                }
            </div>

            <h5 class="mb-3">ë‹´ë‹¹ìë³„ ë¶„ë°°ì„¤ì •</h5>
            <div class="d-flex align-items-center mb-2">
                <span class="me-2">íŒ€ ì„ íƒ</span>
                <select class="form-select w-auto" @bind="selectedTeam">
                    @foreach (var team in teamRows)
                    {
                        <option value="@team.Code">@team.Name</option>
                    }
                </select>
                <div class="form-check form-switch ms-auto">
                    <input class="form-check-input" type="checkbox" id="autoDistUser" @bind="autoDistUser" />
                    <label class="form-check-label" for="autoDistUser">ìë™ ë¶„ë°°</label>
                </div>
            </div>
            <div class="row mb-4">
                @foreach (var user in userRows.Where(u => u.TeamCode == selectedTeam))
                {
                    <div class="col-md-3 mb-2">
                        <div class="input-group">
                            <span class="input-group-text">@user.Name</span>
                            <span class="input-group-text">@user.Code</span>
                            <span class="input-group-text">@user.Priority<span>ìœ„</span></span>
                            <input type="number" class="form-control" min="0" @bind="user.Quantity" />
                        </div>
                    </div>
                }
            </div>

            <h5 class="mb-3">ìƒì‚°ì—…ì²´ë³„ ë¶„ë°°ì„¤ì •</h5>
            <div class="d-flex align-items-center mb-2">
                <span class="me-2">ìƒì‚°ì—…ì²´(DBê³µê¸‰ì—…ì²´/ì†Œê°œ/ê°œì¸/ê¸°íƒ€) - íŒ€ ë§¤ì¹­</span>
                <div class="form-check form-switch ms-auto">
                    <input class="form-check-input" type="checkbox" id="autoDistVendor" @bind="autoDistVendor" />
                    <label class="form-check-label" for="autoDistVendor">ìë™ ë¶„ë°°</label>
                </div>
            </div>
            <div class="row mb-4">
                @foreach (var vendor in vendorRows)
                {
                    <div class="col-md-6 mb-2">
                        <div class="input-group">
                            <span class="input-group-text">@vendor.Name</span>
                            <select class="form-select" @bind="vendor.TeamCode">
                                <option value="">íŒ€ ì„ íƒ</option>
                                @foreach (var team in teamRows)
                                {
                                    <option value="@team.Code">@team.Name</option>
                                }
                            </select>
                        </div>
                    </div>
                }
            </div>
            <div class="mt-4 text-end">
                <button type="button" class="btn btn-dark preview-action" @onclick="SaveDistributionSettings" title="ê³§ ì œê³µ ì˜ˆì • ê¸°ëŠ¥ì…ë‹ˆë‹¤."><span aria-hidden="true">ğŸ’¾</span> ì €ì¥í•˜ê¸°</button>
            </div>
            </section>
        }
        else if (activeTab == Tab.Settings)
        {
            <AuthorizeView Roles="Manager">
            <Authorized>
                <section class="placeholder">
                    <h5>ëª¨ë‹ˆí„°ë§ ì„¤ì •</h5>
                    <div class="rule-grid" style="grid-template-columns: 1fr auto; max-width: 520px;">
                        <div>ì•Œë¦¼ ì£¼ê¸°(ë¶„)</div>
                        <input type="number" min="1" max="1440" value="@DedupeConfig.MonitorIntervalMinutes"
                               @onchange="(e => DedupeConfig.MonitorIntervalMinutes = int.TryParse(e.Value?.ToString(), out var v) ? v : DedupeConfig.MonitorIntervalMinutes)" />

                        <div>ë™ì¼ ê±´ìˆ˜ë„ ì•Œë¦¼</div>
                        <input type="checkbox" checked="@DedupeConfig.NotifyOnSameCount" @onchange="(e => DedupeConfig.NotifyOnSameCount = e.Value is bool b && b)" />
                    </div>
                    <div class="mt-3">
                        <button type="button" class="btn btn-secondary" @onclick="RunMonitorOnce">ì§€ê¸ˆ ê²€ì‚¬</button>
                    </div>
                </section>
            </Authorized>
            <NotAuthorized>
                <section class="placeholder">
                    <p class="text-muted">ì´ ì˜ì—­ì€ ê´€ë¦¬ì ì „ìš©ì…ë‹ˆë‹¤.</p>
                </section>
            </NotAuthorized>
            </AuthorizeView>
        }
    </div>
    </ChildContent>
</PageTemplate>

@code {
    private enum Tab { Explore, Segments, Imports, Dedupe, Grade, Consult, Distribution, Settings }

    // ë¶„ë°°ì„¤ì •ìš© ëª¨ë¸
    private class TeamRow
    {
        public string Code { get; set; } = "";
        public string Name { get; set; } = "";
        public int Priority { get; set; } = 1;
        public int Quantity { get; set; } = 0;
    }
    private class UserRow
    {
        public string Code { get; set; } = "";
        public string Name { get; set; } = "";
        public string TeamCode { get; set; } = "";
        public int Priority { get; set; } = 1;
        public int Quantity { get; set; } = 0;
    }
    private class VendorRow
    {
        public string Name { get; set; } = "";
        public string TeamCode { get; set; } = "";
    }

    private List<TeamRow> teamRows = new()
    {
        new TeamRow { Code = "TM0001", Name = "ì§ì˜", Priority = 1 },
        new TeamRow { Code = "TM0002", Name = "Eliteì§€ì ", Priority = 2 },
        new TeamRow { Code = "TM0003", Name = "SKYì§€ì ", Priority = 3 }
    };
    private List<UserRow> userRows = new()
    {
        new UserRow { Code = "FC0004", Name = "ì°¨ì€ìš°(ì˜ì—…1íŒ€ì¥)", TeamCode = "TM0001", Priority = 1 },
        new UserRow { Code = "FC0005", Name = "ì´í˜œë¦¬(ì˜ì—…1íŒ€ì›)", TeamCode = "TM0001", Priority = 2 },
        new UserRow { Code = "FC0017", Name = "ì´ë³‘í—Œ(ì˜ì—…2íŒ€)", TeamCode = "TM0002", Priority = 1 }
    };
    private List<VendorRow> vendorRows = new()
    {
        new VendorRow { Name = "DBê³µê¸‰ì—…ì²´B" },
        new VendorRow { Name = "DBê³µê¸‰ì—…ì²´A" },
        new VendorRow { Name = "ì†Œê°œ" },
        new VendorRow { Name = "ê°œì¸" },
        new VendorRow { Name = "ê¸°íƒ€ DB" }
    };

    private bool autoDistTeam = false;
    private bool autoDistUser = false;
    private bool autoDistVendor = false;
    private string selectedTeam = "TM0001";

    private async Task SaveDistributionSettings()
    {
        // TODO: ì‹¤ì œ ì €ì¥ ë¡œì§(ì˜ˆ: DB/API ì—°ë™) í•„ìš”
        await NotifyPreviewFeatureAsync("ë¶„ë°° ì„¤ì • ì €ì¥");
    }

    // ìƒë‹´êµ¬ë¶„ê°’ ê´€ë¦¬ìš© ëª¨ë¸
    private class ConsultRow
    {
        public int Id { get; set; }
        public string Name { get; set; } = string.Empty;
        public bool IsSettlement { get; set; } = false;
        public bool IsComplete { get; set; } = false;
        public bool IsActive { get; set; } = true;
        public DateTime CreatedAt { get; set; } = DateTime.Now;
        public DateTime? UpdatedAt { get; set; }
        public int Order { get; set; } = 1;
    }

    private List<ConsultRow> consultRows = new();
    private int nextConsultId = 1;

    private void AddConsultRow()
    {
        consultRows.Add(new ConsultRow
        {
            Id = nextConsultId++,
            Name = "",
            IsSettlement = false,
            IsComplete = false,
            IsActive = true,
            CreatedAt = DateTime.Now,
            Order = consultRows.Count + 1
        });
    }

    private void RemoveConsultRow(int id)
    {
        var row = consultRows.FirstOrDefault(r => r.Id == id);
        if (row != null)
            consultRows.Remove(row);
    }

    private async Task SaveConsultRows()
    {
        foreach (var row in consultRows)
        {
            row.UpdatedAt = DateTime.Now;
        }
        // TODO: ì‹¤ì œ ì €ì¥ ë¡œì§(ì˜ˆ: DB/API ì—°ë™) í•„ìš”
        // í˜„ì¬ëŠ” ë‹¨ìˆœíˆ UpdatedAtë§Œ ê°±ì‹ 
        await NotifyPreviewFeatureAsync("ìƒë‹´ êµ¬ë¶„ê°’ ì €ì¥");
    }

    // ë“±ê¸‰ê´€ë¦¬ìš© ëª¨ë¸
    private class GradeRow
    {
        public int Id { get; set; }
        public string Name { get; set; } = string.Empty;
        public string Description { get; set; } = string.Empty;
        public bool IsActive { get; set; } = true;
        public DateTime CreatedAt { get; set; } = DateTime.Now;
        public DateTime? UpdatedAt { get; set; }
    }

    private List<GradeRow> gradeRows = new();
    private int nextGradeId = 1;

    private void AddGradeRow()
    {
        gradeRows.Add(new GradeRow
        {
            Id = nextGradeId++,
            Name = "",
            Description = "",
            IsActive = true,
            CreatedAt = DateTime.Now
        });
    }

    private void RemoveGradeRow(int id)
    {
        var row = gradeRows.FirstOrDefault(r => r.Id == id);
        if (row != null)
            gradeRows.Remove(row);
    }

    private async Task SaveGradeRows()
    {
        foreach (var row in gradeRows)
        {
            row.UpdatedAt = DateTime.Now;
        }
        // TODO: ì‹¤ì œ ì €ì¥ ë¡œì§(ì˜ˆ: DB/API ì—°ë™) í•„ìš”
        // í˜„ì¬ëŠ” ë‹¨ìˆœíˆ UpdatedAtë§Œ ê°±ì‹ 
        await NotifyPreviewFeatureAsync("ë“±ê¸‰ êµ¬ë¶„ê°’ ì €ì¥");
    }
    private Tab activeTab = Tab.Explore;

    private const int SearchDebounceDelayMilliseconds = 350;

    private List<DbCustomer> data = new();
    private List<DbCustomer> filtered = new();
    private string? search;
    private string? filterStatus;
    private DateTime? filterFrom;
    private DateTime? filterTo;
    private bool isLoading;
    private bool isExporting;
    private readonly HashSet<int> deletingIds = new();
    private CancellationTokenSource? searchDebounceCts;
    private bool dedupeEnabled;
    private int dedupeDays = 30;
    private bool includeFuzzy;
    private List<DuplicateGroup> duplicates = new();
    private Dictionary<string, int> mergePrimary = new();
    private int scoreThreshold;
    private bool showMergeModal;
    private DuplicateGroup? modalGroup;
    private int modalPrimaryId;

    protected override async Task OnInitializedAsync()
    {
        await RefreshDataAsync();
        // Initialize from shared config
        dedupeEnabled = DedupeConfig.Enabled;
        dedupeDays = DedupeConfig.Days;
        includeFuzzy = DedupeConfig.IncludeFuzzy;
        scoreThreshold = DedupeConfig.ScoreThreshold;
        await LoadConfigAsync();
        await RecomputeDuplicates();
    }

    private void SetTab(Tab t) => activeTab = t;

    private void ApplyFilters()
    {
        IEnumerable<DbCustomer> query = data;

        if (!string.IsNullOrWhiteSpace(search))
        {
            var term = search!.Trim();
            query = query.Where(c =>
                (c.CustomerName?.Contains(term, StringComparison.OrdinalIgnoreCase) ?? false)
                || (c.ContactNumber?.Contains(term, StringComparison.OrdinalIgnoreCase) ?? false));
        }

        if (!string.IsNullOrWhiteSpace(filterStatus) && Enum.TryParse<DbStatus>(filterStatus, out var statusFilter))
        {
            query = query.Where(c => c.Status == statusFilter);
        }

        if (filterFrom.HasValue)
        {
            var fromDate = filterFrom.Value.Date;
            query = query.Where(c => c.AssignedDate.Date >= fromDate);
        }

        if (filterTo.HasValue)
        {
            var toDate = filterTo.Value.Date;
            query = query.Where(c => c.AssignedDate.Date <= toDate);
        }

        filtered = query
            .OrderByDescending(c => c.AssignedDate)
            .ThenBy(c => c.CustomerName, StringComparer.OrdinalIgnoreCase)
            .ToList();
    }

    private async Task RefreshDataAsync(CancellationToken cancellationToken = default)
    {
        if (cancellationToken.IsCancellationRequested)
        {
            return;
        }

        isLoading = true;
        StateHasChanged();

        try
        {
            var criteria = BuildCriteria();
            var results = await DbAdminService.SearchAsync(criteria);
            if (cancellationToken.IsCancellationRequested)
            {
                return;
            }

            data = results?.ToList() ?? new List<DbCustomer>();
            ApplyFilters();
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("console.error", "dbAdmin.loadFailed", ex.Message);
            await JS.InvokeVoidAsync("alert", "ê³ ê° ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.");
        }
        finally
        {
            var wasCancelled = cancellationToken.IsCancellationRequested;
            isLoading = false;

            if (!wasCancelled)
            {
                StateHasChanged();
            }
        }
    }

    private DbSearchCriteria BuildCriteria(bool includeDuplicates = false)
    {
        var criteria = new DbSearchCriteria
        {
            CheckDuplicates = includeDuplicates,
            From = filterFrom,
            To = filterTo,
            SearchTerm = string.IsNullOrWhiteSpace(search) ? null : search,
            IncludeArchived = false
        };

        if (!string.IsNullOrWhiteSpace(filterStatus) && Enum.TryParse<DbStatus>(filterStatus, out var status))
        {
            criteria.Status = status;
        }

        return criteria;
    }

    private async Task RecomputeDuplicates(ChangeEventArgs? _ = null)
    {
        // Persist shared config
        DedupeConfig.Enabled = dedupeEnabled;
        DedupeConfig.Days = dedupeDays;
        DedupeConfig.IncludeFuzzy = includeFuzzy;
        DedupeConfig.ScoreThreshold = scoreThreshold;
        await SaveConfigAsync();

        if (!dedupeEnabled)
        {
            duplicates = new();
            return;
        }

        duplicates = (await DuplicateService.FindDuplicatesAsync(dedupeDays, includeFuzzy)).ToList();
        // Initialize merge selection defaults
        mergePrimary = duplicates.ToDictionary(d => d.Key, d => d.Candidates.OrderByDescending(c => c.AssignedDate).First().ContactId);
    }

    // Parameterless helpers for @bind:after (expects Action or Func<Task>)
    private async Task ApplyFiltersAfter()
    {
        ApplyFilters();
        await RefreshDataAsync();
    }

    private async Task OnSearchChanged(ChangeEventArgs args)
    {
        search = args.Value?.ToString();
        ApplyFilters();

        searchDebounceCts?.Cancel();
        searchDebounceCts?.Dispose();

        var cts = new CancellationTokenSource();
        searchDebounceCts = cts;

        try
        {
            await Task.Delay(SearchDebounceDelayMilliseconds, cts.Token);
            await RefreshDataAsync(cts.Token);
        }
        catch (TaskCanceledException)
        {
            // Swallow cancellation when user keeps typing.
        }
        finally
        {
            if (ReferenceEquals(searchDebounceCts, cts))
            {
                searchDebounceCts = null;
            }

            cts.Dispose();
        }
    }
    private Task RecomputeDuplicatesAfter() => RecomputeDuplicates();

    // Rule config bindings (checkbox+weight) with recompute
    private bool UseGender { get => DedupeConfig.UseGender; set { DedupeConfig.UseGender = value; _ = RecomputeDuplicates(); } }
    private int  WeightGender { get => DedupeConfig.WeightGender; set { DedupeConfig.WeightGender = Clamp01(value); _ = RecomputeDuplicates(); } }
    private bool UseAddress { get => DedupeConfig.UseAddress; set { DedupeConfig.UseAddress = value; _ = RecomputeDuplicates(); } }
    private int  WeightAddress { get => DedupeConfig.WeightAddress; set { DedupeConfig.WeightAddress = Clamp01(value); _ = RecomputeDuplicates(); } }
    private bool UseJobTitle { get => DedupeConfig.UseJobTitle; set { DedupeConfig.UseJobTitle = value; _ = RecomputeDuplicates(); } }
    private int  WeightJobTitle { get => DedupeConfig.WeightJobTitle; set { DedupeConfig.WeightJobTitle = Clamp01(value); _ = RecomputeDuplicates(); } }
    private bool UseMaritalStatus { get => DedupeConfig.UseMaritalStatus; set { DedupeConfig.UseMaritalStatus = value; _ = RecomputeDuplicates(); } }
    private int  WeightMaritalStatus { get => DedupeConfig.WeightMaritalStatus; set { DedupeConfig.WeightMaritalStatus = Clamp01(value); _ = RecomputeDuplicates(); } }
    private bool UseProofNumber { get => DedupeConfig.UseProofNumber; set { DedupeConfig.UseProofNumber = value; _ = RecomputeDuplicates(); } }
    private int  WeightProofNumber { get => DedupeConfig.WeightProofNumber; set { DedupeConfig.WeightProofNumber = Clamp01(value); _ = RecomputeDuplicates(); } }
    private bool UseDbPrice { get => DedupeConfig.UseDbPrice; set { DedupeConfig.UseDbPrice = value; _ = RecomputeDuplicates(); } }
    private int  WeightDbPrice { get => DedupeConfig.WeightDbPrice; set { DedupeConfig.WeightDbPrice = Clamp01(value); _ = RecomputeDuplicates(); } }
    private bool UseHeadquarters { get => DedupeConfig.UseHeadquarters; set { DedupeConfig.UseHeadquarters = value; _ = RecomputeDuplicates(); } }
    private int  WeightHeadquarters { get => DedupeConfig.WeightHeadquarters; set { DedupeConfig.WeightHeadquarters = Clamp01(value); _ = RecomputeDuplicates(); } }
    private bool UseInsuranceName { get => DedupeConfig.UseInsuranceName; set { DedupeConfig.UseInsuranceName = value; _ = RecomputeDuplicates(); } }
    private int  WeightInsuranceName { get => DedupeConfig.WeightInsuranceName; set { DedupeConfig.WeightInsuranceName = Clamp01(value); _ = RecomputeDuplicates(); } }
    private bool UseCarJoinDate { get => DedupeConfig.UseCarJoinDate; set { DedupeConfig.UseCarJoinDate = value; _ = RecomputeDuplicates(); } }
    private int  WeightCarJoinDate { get => DedupeConfig.WeightCarJoinDate; set { DedupeConfig.WeightCarJoinDate = Clamp01(value); _ = RecomputeDuplicates(); } }
    private bool UseNotes { get => DedupeConfig.UseNotes; set { DedupeConfig.UseNotes = value; _ = RecomputeDuplicates(); } }
    private int  WeightNotes { get => DedupeConfig.WeightNotes; set { DedupeConfig.WeightNotes = Clamp01(value); _ = RecomputeDuplicates(); } }

    private static int Clamp01(int value) => Math.Max(0, Math.Min(10, value));

    private RenderFragment RuleRow(string label, string bindName, Func<bool> getter, Action<bool> setter, string weightName, Func<int> wGetter, Action<int> wSetter) => builder =>
    {
        var seq = 0;
        builder.OpenElement(seq++, "div");
        builder.AddAttribute(seq++, "class", "rule-row");
        builder.OpenElement(seq++, "label"); builder.AddContent(seq++, label); builder.CloseElement();
        builder.OpenElement(seq++, "input");
        builder.AddAttribute(seq++, "type", "checkbox");
        builder.AddAttribute(seq++, "checked", getter());
        builder.AddAttribute(seq++, "onchange", EventCallback.Factory.Create<ChangeEventArgs>(this, e => setter(e.Value is bool b && b)));
        builder.CloseElement();
        builder.OpenElement(seq++, "input");
        builder.AddAttribute(seq++, "type", "number");
        builder.AddAttribute(seq++, "min", 0);
        builder.AddAttribute(seq++, "max", 10);
        builder.AddAttribute(seq++, "value", wGetter());
        builder.AddAttribute(seq++, "onchange", EventCallback.Factory.Create<ChangeEventArgs>(this, e => {
            if (int.TryParse(e.Value?.ToString(), out var v)) wSetter(v);
        }));
        builder.CloseElement();
        builder.CloseElement();
    };

    private async Task LoadConfigAsync()
    {
        try
        {
            var json = await JS.InvokeAsync<string>("localStorage.getItem", "dedupe-config");
            if (string.IsNullOrWhiteSpace(json)) return;
            var cfg = System.Text.Json.JsonSerializer.Deserialize<LocalConfig>(json);
            if (cfg is null) return;
            dedupeEnabled = cfg.Enabled;
            dedupeDays = cfg.Days;
            includeFuzzy = cfg.IncludeFuzzy;
            scoreThreshold = cfg.ScoreThreshold;
            DedupeConfig.UseGender = cfg.UseGender;
            DedupeConfig.UseAddress = cfg.UseAddress;
            DedupeConfig.UseJobTitle = cfg.UseJobTitle;
            DedupeConfig.UseMaritalStatus = cfg.UseMaritalStatus;
            DedupeConfig.UseProofNumber = cfg.UseProofNumber;
            DedupeConfig.UseDbPrice = cfg.UseDbPrice;
            DedupeConfig.UseHeadquarters = cfg.UseHeadquarters;
            DedupeConfig.UseInsuranceName = cfg.UseInsuranceName;
            DedupeConfig.UseCarJoinDate = cfg.UseCarJoinDate;
            DedupeConfig.UseNotes = cfg.UseNotes;
            DedupeConfig.WeightGender = cfg.WeightGender;
            DedupeConfig.WeightAddress = cfg.WeightAddress;
            DedupeConfig.WeightJobTitle = cfg.WeightJobTitle;
            DedupeConfig.WeightMaritalStatus = cfg.WeightMaritalStatus;
            DedupeConfig.WeightProofNumber = cfg.WeightProofNumber;
            DedupeConfig.WeightDbPrice = cfg.WeightDbPrice;
            DedupeConfig.WeightHeadquarters = cfg.WeightHeadquarters;
            DedupeConfig.WeightInsuranceName = cfg.WeightInsuranceName;
            DedupeConfig.WeightCarJoinDate = cfg.WeightCarJoinDate;
            DedupeConfig.WeightNotes = cfg.WeightNotes;
        }
        catch { }
    }

    private async Task SaveConfigAsync()
    {
        try
        {
            var cfg = new LocalConfig
            {
                Enabled = dedupeEnabled,
                Days = dedupeDays,
                IncludeFuzzy = includeFuzzy,
                ScoreThreshold = scoreThreshold,
                UseGender = DedupeConfig.UseGender,
                UseAddress = DedupeConfig.UseAddress,
                UseJobTitle = DedupeConfig.UseJobTitle,
                UseMaritalStatus = DedupeConfig.UseMaritalStatus,
                UseProofNumber = DedupeConfig.UseProofNumber,
                UseDbPrice = DedupeConfig.UseDbPrice,
                UseHeadquarters = DedupeConfig.UseHeadquarters,
                UseInsuranceName = DedupeConfig.UseInsuranceName,
                UseCarJoinDate = DedupeConfig.UseCarJoinDate,
                UseNotes = DedupeConfig.UseNotes,
                WeightGender = DedupeConfig.WeightGender,
                WeightAddress = DedupeConfig.WeightAddress,
                WeightJobTitle = DedupeConfig.WeightJobTitle,
                WeightMaritalStatus = DedupeConfig.WeightMaritalStatus,
                WeightProofNumber = DedupeConfig.WeightProofNumber,
                WeightDbPrice = DedupeConfig.WeightDbPrice,
                WeightHeadquarters = DedupeConfig.WeightHeadquarters,
                WeightInsuranceName = DedupeConfig.WeightInsuranceName,
                WeightCarJoinDate = DedupeConfig.WeightCarJoinDate,
                WeightNotes = DedupeConfig.WeightNotes
            };
            var json = System.Text.Json.JsonSerializer.Serialize(cfg);
            await JS.InvokeVoidAsync("localStorage.setItem", "dedupe-config", json);
        }
        catch { }
    }

    private void OpenMergeModal(DuplicateGroup g)
    {
        modalGroup = g;
        showMergeModal = true;
        if (!mergePrimary.TryGetValue(g.Key, out modalPrimaryId))
        {
            modalPrimaryId = g.Candidates.OrderByDescending(c => c.AssignedDate).First().ContactId;
        }
    }

    private void CloseMergeModal()
    {
        showMergeModal = false;
        modalGroup = null;
    }

    private async Task ConfirmMergeModal()
    {
        if (modalGroup is null) return;
        var primaryId = modalPrimaryId;
        var dupIds = modalGroup.ContactIds.Where(id => id != primaryId).ToList();
        if (dupIds.Count == 0) { CloseMergeModal(); return; }
        // Apply field overrides to primary before merge
        var patch = await BuildPatchFromSelectionAsync(modalGroup, primaryId);
        if (patch is not null)
        {
            await DbDataService.UpdateCustomerPartialAsync(primaryId, patch, overwriteEmptyOnly: false);
        }
        await DuplicateService.MergeAsync(primaryId, dupIds);
        await RecomputeDuplicates();
        CloseMergeModal();
    }

    private async Task<DbCustomer?> BuildPatchFromSelectionAsync(DuplicateGroup group, int primaryId)
    {
        if (group is null) return null;
        if (!mergeFieldSource.TryGetValue(group.Key, out var dict) || dict.Count == 0) return null;

        var all = await DbDataService.GetAllDbListAsync();
        var byId = all.ToDictionary(c => c.ContactId, c => c);
        var patch = new DbCustomer();

        DbCustomer? From(int id) => byId.TryGetValue(id, out var c) ? c : null;

        if (dict.TryGetValue("Gender", out var gId)) patch.Gender = From(gId)?.Gender;
        if (dict.TryGetValue("Address", out var aId)) patch.Address = From(aId)?.Address;
        if (dict.TryGetValue("JobTitle", out var jId)) patch.JobTitle = From(jId)?.JobTitle;
        if (dict.TryGetValue("MaritalStatus", out var mId)) patch.MaritalStatus = From(mId)?.MaritalStatus;
        if (dict.TryGetValue("ProofNumber", out var pnId)) patch.ProofNumber = From(pnId)?.ProofNumber;
        if (dict.TryGetValue("DbPrice", out var pId)) patch.DbPrice = From(pId)?.DbPrice;
        if (dict.TryGetValue("Headquarters", out var hId)) patch.Headquarters = From(hId)?.Headquarters;
        if (dict.TryGetValue("InsuranceName", out var iId)) patch.InsuranceName = From(iId)?.InsuranceName;
        if (dict.TryGetValue("CarJoinDate", out var cId)) patch.CarJoinDate = From(cId)?.CarJoinDate;
        if (dict.TryGetValue("Notes", out var nId)) patch.Notes = From(nId)?.Notes;

        return patch;
    }

    private readonly Dictionary<string, Dictionary<string, int>> mergeFieldSource = new();

    private RenderFragment FieldSelectRow(string label, string field) => builder =>
    {
        if (modalGroup is null) return;
        var seq = 0;
        builder.OpenElement(seq++, "div");
        builder.AddContent(seq++, label);
        builder.CloseElement();

        builder.OpenElement(seq++, "select");
        builder.AddAttribute(seq++, "class", "form-select form-select-sm");
        builder.AddAttribute(seq++, "style", "width: auto;");
        builder.AddAttribute(seq++, "value", GetMergeFieldSource(modalGroup, field));
        builder.AddAttribute(seq++, "onchange", EventCallback.Factory.Create<ChangeEventArgs>(this, e =>
        {
            if (modalGroup is null) return;
            if (!mergeFieldSource.TryGetValue(modalGroup.Key, out var dict))
            {
                dict = new Dictionary<string, int>();
                mergeFieldSource[modalGroup.Key] = dict;
            }
            if (int.TryParse(e.Value?.ToString(), out var id))
            {
                dict[field] = id;
            }
        }));
        foreach (var c in modalGroup.Candidates.OrderByDescending(x => x.AssignedDate))
        {
            builder.OpenElement(seq++, "option");
            builder.AddAttribute(seq++, "value", c.ContactId);
            builder.AddContent(seq++, $"{c.CustomerName} ({c.ContactId})");
            builder.CloseElement();
        }
        builder.CloseElement();
    };

    private string GetMergeFieldSource(DuplicateGroup g, string field)
    {
        if (!mergeFieldSource.TryGetValue(g.Key, out var dict) || !dict.TryGetValue(field, out var id))
        {
            return modalPrimaryId.ToString();
        }
        return id.ToString();
    }

    private class LocalConfig
    {
        public bool Enabled { get; set; }
        public int Days { get; set; }
        public bool IncludeFuzzy { get; set; }
        public int ScoreThreshold { get; set; }
        public bool UseGender { get; set; }
        public bool UseAddress { get; set; }
        public bool UseJobTitle { get; set; }
        public bool UseMaritalStatus { get; set; }
        public bool UseProofNumber { get; set; }
        public bool UseDbPrice { get; set; }
        public bool UseHeadquarters { get; set; }
        public bool UseInsuranceName { get; set; }
        public bool UseCarJoinDate { get; set; }
        public bool UseNotes { get; set; }
        public int WeightGender { get; set; }
        public int WeightAddress { get; set; }
        public int WeightJobTitle { get; set; }
        public int WeightMaritalStatus { get; set; }
        public int WeightProofNumber { get; set; }
        public int WeightDbPrice { get; set; }
        public int WeightHeadquarters { get; set; }
        public int WeightInsuranceName { get; set; }
        public int WeightCarJoinDate { get; set; }
        public int WeightNotes { get; set; }
    }

    private async Task NotifyAdmin(DuplicateGroup g)
    {
        await NotificationFeed.AddAsync(new NotificationFeedItem
        {
            Title = "ì¤‘ë³µ DB ê°ì§€",
            Message = $"ê·¸ë£¹ {g.ContactDisplay} ì¤‘ë³µ {g.Count}ê±´ (ìµœê·¼ {g.LatestAssigned:yyyy.MM.dd})",
            Type = "warning",
            IsRead = false,
            TimestampUtc = DateTime.UtcNow
        });
    }

    private async Task DeleteCustomerAsync(DbCustomer customer)
    {
        if (customer is null || deletingIds.Contains(customer.ContactId))
        {
            return;
        }

        var name = string.IsNullOrWhiteSpace(customer.CustomerName) ? "ì´ í•­ëª©" : customer.CustomerName;
        var confirmed = await JS.InvokeAsync<bool>("confirm", $"{name}ì„(ë¥¼) ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        if (!confirmed)
        {
            return;
        }

        deletingIds.Add(customer.ContactId);

        try
        {
            await DbAdminService.DeleteEntryAsync(customer.ContactId);
            await RefreshDataAsync();
            await RecomputeDuplicates();
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("console.error", "dbAdmin.deleteFailed", ex.Message);
            await JS.InvokeVoidAsync("alert", "ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.");
        }
        finally
        {
            deletingIds.Remove(customer.ContactId);
            StateHasChanged();
        }
    }

    private async Task ArchiveGroup(DuplicateGroup g)
    {
        await DuplicateService.ArchiveAsync(g);
        await RecomputeDuplicates();
        await RefreshDataAsync();
    }

    private async Task DeleteGroup(DuplicateGroup g)
    {
        var ok = await JS.InvokeAsync<bool>("confirm", $"ì„ íƒëœ {g.Count}ê±´ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        if (!ok) return;
        await DuplicateService.DeleteAsync(g);
        await RecomputeDuplicates();
        await RefreshDataAsync();
    }

    private async Task MergeGroup(DuplicateGroup g)
    {
        if (!mergePrimary.TryGetValue(g.Key, out var primaryId)) return;
        var dupIds = g.ContactIds.Where(id => id != primaryId).ToList();
        if (dupIds.Count == 0) return;
        await DuplicateService.MergeAsync(primaryId, dupIds);
        await RecomputeDuplicates();
        await RefreshDataAsync();
    }

    private Task SaveCurrentView() => NotifyPreviewFeatureAsync("ë³´ê¸° ì €ì¥");

    private async Task ExportCsv()
    {
        if (isExporting)
        {
            return;
        }

        isExporting = true;

        try
        {
            var fields = new List<string>
            {
                nameof(DbCustomer.CustomerName),
                nameof(DbCustomer.ContactNumber),
                nameof(DbCustomer.Group),
                nameof(DbCustomer.AssignedTo),
                nameof(DbCustomer.AssignedDate),
                nameof(DbCustomer.Status),
                nameof(DbCustomer.LastContactDate)
            };

            var bytes = await DbAdminService.ExportToExcelAsync(new DbExportSettings(fields), BuildCriteria());
            if (bytes.Length == 0)
            {
                await JS.InvokeVoidAsync("alert", "ë‚´ë³´ë‚¼ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");
                return;
            }

            var csv = Encoding.UTF8.GetString(bytes);
            var fileName = $"db_export_{DateTime.Now:yyyyMMddHHmmss}.csv";
            await JS.InvokeVoidAsync("downloadCsv", fileName, csv);
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("console.error", "dbAdmin.exportFailed", ex.Message);
            await JS.InvokeVoidAsync("alert", "CSV ë‚´ë³´ë‚´ê¸°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.");
        }
        finally
        {
            isExporting = false;
        }
    }

    private Task OnImportFileSelected(ChangeEventArgs e) => NotifyPreviewFeatureAsync("ê³ ê° DB ì¶”ê°€í•˜ê¸°");

    private Task NotifyPreviewFeatureAsync(string featureName)
    {
        return JS.InvokeVoidAsync("alert", $"{featureName} ê¸°ëŠ¥ì€ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤. ê³§ ì œê³µë  ì˜ˆì •ì…ë‹ˆë‹¤.").AsTask();
    }

    public void Dispose()
    {
        searchDebounceCts?.Cancel();
        searchDebounceCts?.Dispose();
        searchDebounceCts = null;
    }

    private static string GetStatusClass(DbStatus status) => status switch
    {
        DbStatus.New => "status-text status-new",
        DbStatus.InProgress => "status-text status-inprogress",
        DbStatus.NoAnswer => "status-text status-noanswer",
        DbStatus.Completed => "status-text status-completed",
        DbStatus.OnHold => "status-text status-onhold",
        _ => "status-text"
    };

    [Inject] private IDuplicateMonitorService Monitor { get; set; } = default!;
    private async Task RunMonitorOnce() => await Monitor.RunOnceAsync();

    private string TabClass(Tab tab)
    {
        const string BaseClass = "db-tab";
        return activeTab == tab ? string.Join(' ', BaseClass, "db-tab--active") : BaseClass;
    }
}
