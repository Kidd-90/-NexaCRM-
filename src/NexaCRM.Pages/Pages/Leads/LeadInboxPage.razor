@page "/leads"
@using System.Linq
@using NexaCRM.Service.Models.DB
@using TaskAsync = System.Threading.Tasks.Task
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Components.Web
@using NexaCRM.Pages.Components.Shared
@inject NavigationManager NavigationManager
@inject AuthenticationStateProvider AuthStateProvider

<PageTemplate Title="ë¦¬ë“œ ë°›ì€í¸ì§€í•¨"
              Description="ìƒˆë¡œìš´ ì ì¬ ê³ ê°ì„ í™•ì¸í•˜ê³  ê´€ë¦¬í•©ë‹ˆë‹¤">
    
    <HeaderActions>
        <button type="button" class="btn btn-primary" @onclick="CreateNewLead">
            â• ìƒˆ ë¦¬ë“œ ì¶”ê°€
        </button>
        <button type="button" class="btn btn-outline-secondary" @onclick="RefreshLeads">
            ğŸ”„ ìƒˆë¡œê³ ì¹¨
        </button>
    </HeaderActions>

    <ChildContent>
        @if (IsLoading)
        {
            <div class="text-center py-5">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">ë¡œë”© ì¤‘...</span>
                </div>
                <p class="mt-2 text-muted">ë¦¬ë“œ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
            </div>
        }
        else if (!string.IsNullOrEmpty(ErrorMessage))
        {
            <div class="alert alert-danger" role="alert">
                <i class="bi bi-exclamation-triangle"></i> @ErrorMessage
            </div>
        }
        else
        {
            <!-- Filters -->
            <div class="card mb-3">
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-3">
                            <label class="form-label">ìƒíƒœ</label>
                            <select class="form-select" @bind="FilterStatus">
                                <option value="">ì „ì²´</option>
                                <option value="New">ì‹ ê·œ</option>
                                <option value="Contacted">ì ‘ì´‰ë¨</option>
                                <option value="Qualified">ê²€ì¦ë¨</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">ì†ŒìŠ¤</label>
                            <select class="form-select" @bind="FilterSourceId">
                                <option value="0">ì „ì²´</option>
                                @foreach (var source in LeadSources)
                                {
                                    <option value="@source.Id">@source.Name</option>
                                }
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">ë‹´ë‹¹ì</label>
                            <select class="form-select" @bind="FilterAssignedTo">
                                <option value="">ì „ì²´</option>
                                <option value="me">ë‚´ê°€ ë‹´ë‹¹</option>
                                <option value="unassigned">ë¯¸ë°°ì •</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">ê²€ìƒ‰</label>
                            <input type="text" class="form-control" placeholder="ì´ë¦„, ì´ë©”ì¼, íšŒì‚¬ëª…..." @bind="SearchTerm" @bind:event="oninput" @onkeyup="OnSearchChanged" />
                        </div>
                    </div>
                    <div class="mt-2">
                        <button type="button" class="btn btn-sm btn-secondary" @onclick="ApplyFilters">
                            <span aria-hidden="true">ğŸ”</span> í•„í„° ì ìš©
                        </button>
                        <button type="button" class="btn btn-sm btn-outline-secondary" @onclick="ClearFilters">
                            <span aria-hidden="true">âœ–ï¸</span> í•„í„° ì´ˆê¸°í™”
                        </button>
                    </div>
                </div>
            </div>

            <!-- Stats Cards -->
            <div class="row g-3 mb-4">
                <div class="col-md-3">
                    <div class="card border-primary">
                        <div class="card-body">
                            <h6 class="card-subtitle mb-2 text-muted">ì´ ë¦¬ë“œ</h6>
                            <h3 class="card-title">@FilteredLeads.Count()</h3>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card border-success">
                        <div class="card-body">
                            <h6 class="card-subtitle mb-2 text-muted">ì‹ ê·œ</h6>
                            <h3 class="card-title">@FilteredLeads.Count(l => l.Status == LeadStatus.New)</h3>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card border-warning">
                        <div class="card-body">
                            <h6 class="card-subtitle mb-2 text-muted">ì ‘ì´‰ë¨</h6>
                            <h3 class="card-title">@FilteredLeads.Count(l => l.Status == LeadStatus.Contacted)</h3>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card border-info">
                        <div class="card-body">
                            <h6 class="card-subtitle mb-2 text-muted">ê²€ì¦ë¨</h6>
                            <h3 class="card-title">@FilteredLeads.Count(l => l.Status == LeadStatus.Qualified)</h3>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Leads List -->
            @if (!FilteredLeads.Any())
            {
                <div class="alert alert-info">
                    <i class="bi bi-info-circle"></i> ì¡°ê±´ì— ë§ëŠ” ë¦¬ë“œê°€ ì—†ìŠµë‹ˆë‹¤.
                </div>
            }
            else
            {
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>ì´ë¦„</th>
                                <th>íšŒì‚¬</th>
                                <th>ì—°ë½ì²˜</th>
                                <th>ì†ŒìŠ¤</th>
                                <th>ì ìˆ˜</th>
                                <th>ìƒíƒœ</th>
                                <th>ë‹´ë‹¹ì</th>
                                <th>ìƒì„±ì¼</th>
                                <th>ì•¡ì…˜</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var lead in FilteredLeads.Take(50))
                            {
                                <tr class="@GetRowClass(lead)">
                                    <td>
                                        <div class="fw-bold">@lead.FullName</div>
                                        @if (!string.IsNullOrEmpty(lead.Title))
                                        {
                                            <small class="text-muted">@lead.Title</small>
                                        }
                                    </td>
                                    <td>@lead.CompanyName</td>
                                    <td>
                                        @if (!string.IsNullOrEmpty(lead.Email))
                                        {
                                            <div><i class="bi bi-envelope"></i> @lead.Email</div>
                                        }
                                        @if (!string.IsNullOrEmpty(lead.Phone))
                                        {
                                            <div><i class="bi bi-telephone"></i> @lead.Phone</div>
                                        }
                                    </td>
                                    <td>
                                        @if (!string.IsNullOrEmpty(lead.SourceName))
                                        {
                                            <span class="badge bg-secondary">@lead.SourceName</span>
                                        }
                                    </td>
                                    <td>
                                        @if (lead.LeadScore.HasValue)
                                        {
                                            <span class="badge @GetScoreBadgeClass(lead.LeadScore.Value)">
                                                @lead.LeadScore
                                            </span>
                                        }
                                    </td>
                                    <td>
                                        <span class="badge @GetStatusBadgeClass(lead.Status)">
                                            @GetStatusLabel(lead.Status)
                                        </span>
                                    </td>
                                    <td>
                                        @if (!string.IsNullOrEmpty(lead.AssignedToName))
                                        {
                                            @lead.AssignedToName
                                        }
                                        else
                                        {
                                            <span class="text-muted">ë¯¸ë°°ì •</span>
                                        }
                                    </td>
                                    <td>
                                        <span title="@lead.CreatedAt.ToString("yyyy-MM-dd HH:mm")">
                                            @GetRelativeTime(lead.CreatedAt)
                                        </span>
                                        @if (lead.IsOverdue)
                                        {
                                            <span class="badge bg-danger ms-1">ì§€ì—°</span>
                                        }
                                    </td>
                                    <td>
                                        <div class="btn-group btn-group-sm">
                                            <button type="button" class="btn btn-outline-primary" @onclick="() => ViewLead(lead.Id)" title="ìƒì„¸ë³´ê¸°">
                                                ğŸ‘ï¸
                                            </button>
                                            <button type="button" class="btn btn-outline-success" @onclick="() => ConvertLead(lead.Id)" title="ê³ ê°ì „í™˜">
                                                â¡ï¸
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>

                @if (FilteredLeads.Count() > 50)
                {
                    <div class="alert alert-info mt-3">
                        ì²˜ìŒ 50ê°œë§Œ í‘œì‹œë©ë‹ˆë‹¤. ì´ @FilteredLeads.Count()ê°œì˜ ë¦¬ë“œê°€ ìˆìŠµë‹ˆë‹¤.
                    </div>
                }
            }
        }
    </ChildContent>
</PageTemplate>

@code {
    private List<Lead> Leads = new();
    private List<LeadSource> LeadSources = new();
    private bool IsLoading = true;
    private string? ErrorMessage;
    
    // Filters
    private string FilterStatus = "";
    private long FilterSourceId = 0;
    private string FilterAssignedTo = "";
    private string SearchTerm = "";
    private Guid? CurrentUserId;

    private IEnumerable<Lead> FilteredLeads => ApplyClientFilters();

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        try
        {
            IsLoading = true;
            ErrorMessage = null;

            var authState = await AuthStateProvider.GetAuthenticationStateAsync();
            var user = authState.User;
            if (user.Identity?.IsAuthenticated == true)
            {
                var userIdClaim = user.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier);
                if (userIdClaim != null && Guid.TryParse(userIdClaim.Value, out var userId))
                {
                    CurrentUserId = userId;
                }
            }

            // TODO: Replace with actual service calls when implemented
            // var filter = new LeadFilterCriteria();
            // Leads = (await LeadService.GetLeadsAsync(filter)).ToList();
            // LeadSources = (await LeadSourceService.GetLeadSourcesAsync()).ToList();
            
            // Mock data for now
            Leads = GenerateMockLeads();
            LeadSources = GenerateMockSources();
        }
        catch (Exception ex)
        {
            ErrorMessage = $"ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨: {ex.Message}";
        }
        finally
        {
            IsLoading = false;
        }
    }

    private IEnumerable<Lead> ApplyClientFilters()
    {
        var query = Leads.AsEnumerable();

        if (!string.IsNullOrEmpty(FilterStatus) && Enum.TryParse<LeadStatus>(FilterStatus, out var status))
        {
            query = query.Where(l => l.Status == status);
        }

        if (FilterSourceId > 0)
        {
            query = query.Where(l => l.LeadSourceId == FilterSourceId);
        }

        if (FilterAssignedTo == "me" && CurrentUserId.HasValue)
        {
            query = query.Where(l => l.AssignedTo == CurrentUserId.Value);
        }
        else if (FilterAssignedTo == "unassigned")
        {
            query = query.Where(l => !l.AssignedTo.HasValue);
        }

        if (!string.IsNullOrWhiteSpace(SearchTerm))
        {
            var term = SearchTerm.ToLower();
            query = query.Where(l =>
                (l.FirstName?.ToLower().Contains(term) == true) ||
                (l.LastName?.ToLower().Contains(term) == true) ||
                (l.Email?.ToLower().Contains(term) == true) ||
                (l.CompanyName?.ToLower().Contains(term) == true));
        }

        return query.OrderByDescending(l => l.CreatedAt);
    }

    private void ApplyFilters() => StateHasChanged();
    private void ClearFilters()
    {
        FilterStatus = "";
        FilterSourceId = 0;
        FilterAssignedTo = "";
        SearchTerm = "";
        StateHasChanged();
    }

    private async void RefreshLeads() => await LoadData();
    private void CreateNewLead() => NavigationManager.NavigateTo("/leads/new");
    private void ViewLead(long id) => NavigationManager.NavigateTo($"/leads/{id}");
    
    private async void ConvertLead(long id)
    {
        // TODO: Implement conversion logic
        // await LeadService.ConvertLeadToCustomerAsync(id, CurrentUserId.Value);
        await LoadData();
    }

    private void OnSearchChanged(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            ApplyFilters();
        }
    }

    private string GetRowClass(Lead lead)
    {
        if (lead.IsOverdue) return "table-danger";
        if (lead.Status == LeadStatus.New) return "table-success";
        return "";
    }

    private string GetStatusBadgeClass(LeadStatus status) => status switch
    {
        LeadStatus.New => "bg-success",
        LeadStatus.Contacted => "bg-warning",
        LeadStatus.Qualified => "bg-info",
        LeadStatus.Converted => "bg-primary",
        LeadStatus.Lost => "bg-danger",
        _ => "bg-secondary"
    };

    private string GetStatusLabel(LeadStatus status) => status switch
    {
        LeadStatus.New => "ì‹ ê·œ",
        LeadStatus.Contacted => "ì ‘ì´‰ë¨",
        LeadStatus.Qualified => "ê²€ì¦ë¨",
        LeadStatus.Converted => "ì „í™˜ë¨",
        LeadStatus.Lost => "ì‹¤íŒ¨",
        _ => "ì•Œ ìˆ˜ ì—†ìŒ"
    };

    private string GetScoreBadgeClass(int score)
    {
        if (score >= 80) return "bg-success";
        if (score >= 50) return "bg-warning";
        return "bg-danger";
    }

    private string GetRelativeTime(DateTime date)
    {
        var diff = DateTime.UtcNow - date;
        if (diff.TotalDays < 1) return "ì˜¤ëŠ˜";
        if (diff.TotalDays < 2) return "ì–´ì œ";
        if (diff.TotalDays < 7) return $"{(int)diff.TotalDays}ì¼ ì „";
        if (diff.TotalDays < 30) return $"{(int)(diff.TotalDays / 7)}ì£¼ ì „";
        return date.ToString("yyyy-MM-dd");
    }

    // Mock data generators (remove when real service is implemented)
    private List<Lead> GenerateMockLeads()
    {
        return new List<Lead>
        {
            new Lead { Id = 1, FirstName = "ê¹€", LastName = "ì² ìˆ˜", Email = "kim@example.com", Phone = "010-1234-5678", 
                CompanyName = "ABC ì£¼ì‹íšŒì‚¬", Status = LeadStatus.New, LeadSourceId = 1, SourceName = "ì›¹ì‚¬ì´íŠ¸", LeadScore = 85, CreatedAt = DateTime.UtcNow.AddDays(-1) },
            new Lead { Id = 2, FirstName = "ì´", LastName = "ì˜í¬", Email = "lee@example.com", Phone = "010-2345-6789", 
                CompanyName = "XYZ Corp", Status = LeadStatus.Contacted, LeadSourceId = 2, SourceName = "Facebook", LeadScore = 65, CreatedAt = DateTime.UtcNow.AddDays(-3) },
            new Lead { Id = 3, FirstName = "ë°•", LastName = "ë¯¼ìˆ˜", Email = "park@example.com", Phone = "010-3456-7890", 
                CompanyName = "Tech Innovations", Status = LeadStatus.Qualified, LeadSourceId = 3, SourceName = "Google Ads", LeadScore = 90, CreatedAt = DateTime.UtcNow.AddDays(-5) },
        };
    }

    private List<LeadSource> GenerateMockSources()
    {
        return new List<LeadSource>
        {
            new LeadSource { Id = 1, Name = "ì›¹ì‚¬ì´íŠ¸", Category = "direct", IsActive = true },
            new LeadSource { Id = 2, Name = "Facebook", Category = "marketing", IsActive = true },
            new LeadSource { Id = 3, Name = "Google Ads", Category = "marketing", IsActive = true },
            new LeadSource { Id = 4, Name = "ì¶”ì²œ", Category = "referral", IsActive = true },
        };
    }
}
