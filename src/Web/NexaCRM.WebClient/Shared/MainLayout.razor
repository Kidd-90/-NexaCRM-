@inherits LayoutComponentBase
@using NexaCRM.WebClient.Shared
@inject IJSRuntime JSRuntime

<div class="page">
    <!-- ê³ ì •ëœ í–„ë²„ê±° ë²„íŠ¼ - sidebar ë°–ì— ë°°ì¹˜ -->
    <button title="Navigation menu" class="floating-menu-toggle" @onclick="ToggleNavMenu">
        <span class="navbar-toggler-icon"></span>
    </button>
    
    <!-- Theme Toggle Button -->
    <button title="Toggle theme" class="theme-toggle-button" data-theme-toggle aria-label="Switch theme">
        <span class="theme-light-icon">ğŸŒ</span>
        <span class="theme-dark-icon">ğŸŒ™</span>
    </button>
    
    <div class="sidebar">
        <NavMenu />
    </div>
    <div class="mobile-overlay" @onclick="() => {}"></div>
    <main>
        <article class="content px-4 page-fade-enter">
            @Body
        </article>
    </main>
    

</div>

@code {
    private bool collapseNavMenu = true;

    private async Task ToggleNavMenu()
    {
        collapseNavMenu = !collapseNavMenu;
        // JavaScript í•¨ìˆ˜ í˜¸ì¶œí•˜ì—¬ UI ì—…ë°ì´íŠ¸
        await JSRuntime.InvokeVoidAsync("window.navigationHelper.toggleMenu", collapseNavMenu);
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            // ì´ˆê¸° ë Œë”ë§ í›„ JavaScript ì´ˆê¸°í™”
            await JSRuntime.InvokeVoidAsync("window.navigationHelper.setupOverlayHandler");
            // ì´ˆê¸° ìƒíƒœë¥¼ í™•ì‹¤íˆ ì„¤ì • (ë©”ë‰´ ë‹«íŒ ìƒíƒœ)
            await JSRuntime.InvokeVoidAsync("window.navigationHelper.toggleMenu", true);
            
            // í…Œë§ˆ í† ê¸€ ì•„ì´ì½˜ ì´ˆê¸°í™”
            await JSRuntime.InvokeVoidAsync("updateMainThemeToggleIcon");
        }
    }
}

<script>
    // Update main theme toggle button icons based on current theme
    function updateMainThemeToggleIcon() {
        const themeToggle = document.querySelector('.theme-toggle-button');
        if (!themeToggle) return;
        
        const lightIcon = themeToggle.querySelector('.theme-light-icon');
        const darkIcon = themeToggle.querySelector('.theme-dark-icon');
        
        if (!lightIcon || !darkIcon) return;
        
        // Get current theme from document attribute or localStorage
        const currentTheme = document.documentElement.getAttribute('data-theme') || 
                           localStorage.getItem('nexacrm-theme-preference') || 
                           'light';
        
        // Get system theme if theme is set to auto
        let effectiveTheme = currentTheme;
        if (currentTheme === 'auto') {
            effectiveTheme = window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
        }
        
        // Update icon visibility based on effective theme
        if (effectiveTheme === 'dark') {
            lightIcon.style.display = 'inline';
            darkIcon.style.display = 'none';
            themeToggle.setAttribute('aria-label', 'Switch to light theme');
        } else {
            lightIcon.style.display = 'none';
            darkIcon.style.display = 'inline';
            themeToggle.setAttribute('aria-label', 'Switch to dark theme');
        }
        
        console.log('Main theme toggle icon updated for theme:', effectiveTheme);
    }

    // Ensure theme toggle works on main layout
    document.addEventListener('DOMContentLoaded', function() {
        // Immediately update theme icon
        updateMainThemeToggleIcon();
        
        // Wait a bit for all scripts to load, then setup listeners
        setTimeout(function() {
            if (window.themeManager && window.themeManager.setupThemeToggleListeners) {
                window.themeManager.setupThemeToggleListeners();
                console.log('Theme toggle listeners setup for main layout');
            }
            
            // Update icon again after theme manager is initialized
            setTimeout(updateMainThemeToggleIcon, 100);
        }, 500);
    });
    
    // Also setup on page show (for browser back/forward navigation)
    window.addEventListener('pageshow', function() {
        updateMainThemeToggleIcon();
        
        setTimeout(function() {
            if (window.themeManager && window.themeManager.setupThemeToggleListeners) {
                window.themeManager.setupThemeToggleListeners();
            }
            updateMainThemeToggleIcon();
        }, 100);
    });
    
    // Listen for theme changes to update icon
    window.addEventListener('themeChanged', function() {
        setTimeout(updateMainThemeToggleIcon, 50);
    });
    
    // Listen for system theme changes (for auto mode)
    if (window.matchMedia) {
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', function() {
            const currentTheme = localStorage.getItem('nexacrm-theme-preference') || 'auto';
            if (currentTheme === 'auto') {
                setTimeout(updateMainThemeToggleIcon, 50);
            }
        });
    }
    
    // Listen for Blazor navigation events to re-update theme toggle icons
    window.addEventListener('blazorNavigated', function() {
        setTimeout(updateMainThemeToggleIcon, 100);
    });
    
    // Make function globally available
    window.updateMainThemeToggleIcon = updateMainThemeToggleIcon;

    // Also make it available through theme manager
    if (window.themeManager) {
        window.themeManager.updateMainThemeToggleIcon = updateMainThemeToggleIcon;
    }
</script>
